<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸŒŠ Ocean Guardian Story Builder â€“ Complete Learning Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    .writing-panel { min-height:24rem; }
    @media(min-width:1024px){ .writing-panel{ min-height:32rem; } }
    #focus-alert {position:fixed;top:10px;right:10px;background:#fb7185;color:white;padding:8px 12px;border-radius:8px;font-size:14px;display:none;z-index:100;}
    .fs-overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,23,.7);color:#fff;z-index:80}
    .fs-overlay.show{display:grid}
    .tab-active{background:linear-gradient(135deg,#0c4a6e,#0ea5e9);color:white}
    .progress-bar{transition:width .3s ease}
    .guardian-preview{background:linear-gradient(135deg,#e0f2fe,#b3e5fc);border:2px dashed #0ea5e9}
    .plot-mountain{background:linear-gradient(135deg,#f8fafc,#e2e8f0)}
    .story-stage{transition:all .3s ease;min-height:120px}
    .story-stage:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(0,0,0,.1)}
    .story-stage.completed{border-color:#22c55e !important;box-shadow:0 0 20px rgba(34,197,94,0.3);}
    .ocean-wave {
      background: linear-gradient(45deg, #0ea5e9, #06b6d4, #0891b2);
      animation: wave 3s ease-in-out infinite;
    }
    @keyframes wave {
      0%, 100% { transform: translateY(0px
      50% { transform: translateY(-5px); }
    }
    .guardian-card {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 2px solid #0ea5e9;
      transition: all 0.3s ease;
    }
    .guardian-card:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.2);
    }
    .story-element {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-left: 4px solid #f59e0b;
    }
    .completed-section {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      border-color: #22c55e;
    }
    .prompt-btn:hover {
      transform: translateY(-1px);
    }
    .writing-tools {
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
    }
    .drag-handle {
      cursor: grab;
    }
    .drag-handle:active {
      cursor: grabbing;
    }
    .story-event {
      background: white;
      border: 2px dashed #e5e7eb;
      transition: all 0.3s ease;
    }
    .story-event:hover {
      border-color: #0ea5e9;
      transform: translateY(-2px);
    }
    .story-event.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    .feedback-panel {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-left: 4px solid #f59e0b;
    }
    .grammar-error {
      background-color: #fecaca;
      border-bottom: 2px wavy #ef4444;
      cursor: pointer;
    }
    .style-suggestion {
      background-color: #ddd6fe;
      border-bottom: 2px wavy #8b5cf6;
      cursor: pointer;
    }
    .feedback-tooltip {
      position: absolute;
      background: #1f2937;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 1000;
      max-width: 250px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: none;
    }
    .feedback-score {
      background: linear-gradient(135deg, #e0f2fe, #b3e5fc);
      border: 2px solid #0ea5e9;
    }
    .writing-strength {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      border-left: 4px solid #22c55e;
    }
    .writing-improvement {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-left: 4px solid #f59e0b;
    }
    .word-suggestion-box {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 2px solid #0ea5e9;
      border-radius: 8px;
    }
    .weak-word {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #f59e0b;
    }
    .strong-word {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #22c55e;
    }
    .mini-lesson {
      background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
      border: 2px solid #a855f7;
    }
    .vocabulary-bank {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 2px solid #f59e0b;
    }
    .peer-review-card {
      background: linear-gradient(135deg, #ecfdf5, #d1fae5);
      border: 2px solid #10b981;
    }
    .teacher-dashboard {
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      border: 2px solid #ef4444;
    }
    .rubric-section {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border-left: 4px solid #0ea5e9;
    }
    .character-map {
      background: linear-gradient(135deg, #fdf4ff, #fae8ff);
      border: 2px solid #d946ef;
    }
    .conservation-fact {
      background: linear-gradient(135deg, #ecfccb, #d9f99d);
      border-left: 4px solid #65a30d;
    }
    .collaboration-zone {
      background: linear-gradient(135deg, #fff7ed, #fed7aa);
      border: 2px solid #ea580c;
    }
    .accessibility-panel {
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      border: 2px solid #64748b;
    }
    .theme-dark {
      background: #1f2937;
      color: #f9fafb;
    }
    .theme-high-contrast {
      background: #000000;
      color: #ffffff;
    }
    .font-large {
      font-size: 1.25rem;
      line-height: 1.75rem;
    }
    .font-xl {
      font-size: 1.5rem;
      line-height: 2rem;
    }
    .offline-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #ef4444;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      display: none;
    }
    .online-indicator {
      background: #10b981;
    }
    .undo-redo-panel {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border: 1px solid #e2e8f0;
    }
    .multimedia-panel {
      background: linear-gradient(135deg, #fef7ff, #f3e8ff);
      border: 2px solid #a855f7;
    }
    .ocean-map {
      background: linear-gradient(135deg, #e0f2fe, #bae6fd);
      border: 2px solid #0284c7;
    }
    .cross-curricular {
      background: linear-gradient(135deg, #fff1f2, #fecaca);
      border-left: 4px solid #dc2626;
    }
    .tutorial-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      z-index: 1000;
    }
    .tutorial-step {
      position: absolute;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      max-width: 300px;
    }
    .portfolio-item {
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      border: 2px solid #16a34a;
      transition: all 0.3s ease;
    }
    .portfolio-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    .analytics-chart {
      background: linear-gradient(135deg, #fefce8, #fef3c7);
      border: 2px solid #eab308;
    }
    .real-time-collab {
      border-left: 4px solid #8b5cf6;
      background: linear-gradient(135deg, #faf5ff, #f3e8ff);
    }
    .user-cursor {
      position: absolute;
      width: 2px;
      height: 20px;
      background: #ef4444;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
    .speaking-animation {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .literary-term {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 1px solid #f59e0b;
    }
    .tutorial-highlight {
      position: relative;
      z-index: 1001;
      box-shadow: 0 0 0 4px #3b82f6, 0 0 0 8px rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      animation: tutorialPulse 2s infinite;
    }
    @keyframes tutorialPulse {
      0%, 100% { box-shadow: 0 0 0 4px #3b82f6, 0 0 0 8px rgba(59, 130, 246, 0.3); }
      50% { box-shadow: 0 0 0 4px #3b82f6, 0 0 0 12px rgba(59, 130, 246, 0.2); }
    }
      <style>
  /* ...all your existing CSS... */

  /* HOTFIX: Stabilize plot mountain points */
  .plot-point {
    pointer-events: auto;
    transform: scale(1) !important;
    transition: none !important;
    r: 10 !important;
    stroke: #0f172a;
    stroke-width: 2;
    cursor: pointer;
  }
  .plot-point:hover {
    transform: scale(1.2) !important;
    transition: transform 0.15s ease;
  }
</style>


  </style>
</head>
<body class="bg-slate-50 min-h-screen" id="main-body">


  <!-- Accessibility Panel -->
  <div id="accessibility-panel" class="accessibility-panel fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 hidden">
    <h3 class="font-semibold mb-3">â™¿ Accessibility Options</h3>
    <div class="space-y-2">
      <button id="toggle-tts" class="w-full bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded text-sm transition-colors">ğŸ”Š Text-to-Speech</button>
      <button id="toggle-theme" class="w-full bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded text-sm transition-colors">ğŸŒ™ Dark Mode</button>
      <button id="toggle-contrast" class="w-full bg-yellow-100 hover:bg-yellow-200 px-3 py-2 rounded text-sm transition-colors">âš¡ High Contrast</button>
      <select id="font-size" class="w-full border rounded px-2 py-1 text-sm">
        <option value="normal">Normal Font</option>
        <option value="large">Large Font</option>
        <option value="xl">Extra Large Font</option>
      </select>
      <select id="language-select" class="w-full border rounded px-2 py-1 text-sm">
        <option value="en">English</option>
        <option value="es">EspaÃ±ol</option>
        <option value="fr">FranÃ§ais</option>
        <option value="de">Deutsch</option>
        <option value="zh">ä¸­æ–‡</option>
      </select>
    </div>
  </div>

  <!-- Tutorial Overlay -->
  <div id="tutorial-overlay" class="tutorial-overlay">
    <div id="tutorial-step" class="tutorial-step">
      <h3 class="font-semibold mb-2">Welcome to Ocean Guardian Story Builder!</h3>
      <p class="text-sm mb-4">Let's take a quick tour to get you started.</p>
      <div class="flex justify-between">
        <button id="skip-tutorial" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded text-sm font-medium transition-colors">Skip Tour</button>
        <button id="next-tutorial" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">Next</button>
      </div>
    </div>
  </div>

  <!-- Offline Indicator -->
  <div id="offline-indicator" class="offline-indicator">
    ğŸ“¡ Working Offline - Changes saved locally
  </div>

  <!-- Header -->
  <header class="bg-sky-700 text-white p-4 shadow ocean-wave">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 bg-cyan-400 rounded-full grid place-items-center text-xl">ğŸŒŠ</div>
        <h1 class="text-xl md:text-2xl font-semibold">Ocean Guardian Story Builder</h1>
      </div>
      <div class="flex items-center gap-4">
        <button id="accessibility-btn" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors">â™¿</button>
        <button id="help-btn" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors">â“</button>
        <div class="text-xs md:text-sm opacity-90">Complete Learning Platform</div>
      </div>
    </div>
  </header>

  <!-- Focus Guard Bar -->
  <div id="focusBar" class="sticky top-0 bg-white border-b p-2 text-sm flex flex-wrap items-center gap-3 z-40">
    <button id="focusStartBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded transition-colors">Start Focus</button>
    <button id="focusStopBtn" class="bg-gray-300 hover:bg-gray-400 px-3 py-1 rounded transition-colors hidden">Stop Focus</button>
    <div class="flex items-center gap-2">
      <span id="focusStatusDot" class="inline-block w-2.5 h-2.5 rounded-full bg-red-500"></span>
      <span id="focusStatusText" class="text-gray-700">Inactive</span>
      <span id="wakeStatus" class="text-xs text-gray-500 hidden">â€¢ Wake Lock: <b id="wakeFlag">checkingâ€¦</b></span>
    </div>
    <span>Switches: <b id="offTaskCount">0</b></span>
    <span>Off-task: <b id="offTaskTime">0s</b></span>
    
    <!-- Undo/Redo Panel -->
    <div class="undo-redo-panel px-3 py-1 rounded flex items-center gap-2 ml-4">
      <button id="undo-btn" class="hover:bg-gray-200 px-2 py-1 rounded text-xs transition-colors" disabled>â†¶ Undo</button>
      <button id="redo-btn" class="hover:bg-gray-200 px-2 py-1 rounded text-xs transition-colors" disabled>â†· Redo</button>
    </div>
    
    <label class="ml-auto flex items-center gap-1">
      <input type="checkbox" id="confirmLeave" class="accent-sky-600" checked />
      <span class="text-gray-700">Warn on leave</span>
    </label>
  </div>
  <div id="focus-alert">âš ï¸ Off-task detected!</div>
  <div id="fsHint" class="fs-overlay">
    <div class="text-center px-6">
      <div class="text-2xl mb-2">ğŸ”’ Focus Mode</div>
      <p class="mb-4 text-sm opacity-90">Please allow fullscreen to begin focus mode. Press Esc only when you finish.</p>
      <button id="fsHintBtn" class="bg-sky-600 hover:bg-sky-700 px-4 py-2 rounded transition-colors">Continue</button>
    </div>
  </div>

  <!-- Subâ€‘header: student name + progress -->
  <div class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
      <label class="flex items-center gap-2">
        <span class="text-sm font-medium text-gray-600">Student Name:</span>
        <input id="student-name" type="text" class="border rounded px-3 py-1 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Enter your name"/>
      </label>
      
      <!-- Real-time Collaboration Indicator -->
      <div id="collaboration-status" class="real-time-collab px-3 py-1 rounded hidden">
        <span class="text-sm">ğŸ‘¥ <span id="active-users">1</span> user(s) online</span>
      </div>
      
      <div class="ml-auto flex items-center gap-4 text-xs text-gray-500">
        <span id="overall-progress">Progress: 0/8 sections completed</span>
        <div class="w-32 h-2 bg-gray-200 rounded-full">
          <div id="progress-bar" class="progress-bar h-full bg-sky-600 rounded-full" style="width: 0%"></div>
        </div>
        <button id="save-status" class="text-green-600">ğŸ’¾ Auto-saved</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto p-4">
    <!-- Simplified Tab Navigation -->
    <div class="flex gap-2 mb-6 bg-white p-2 rounded-lg shadow-sm" style="position:sticky;top:0;z-index:50;">
      <button class="tab-btn tab-active px-6 py-3 rounded-md transition-all text-lg" data-tab="guardian">
        ğŸ¦¸â€â™€ï¸ Create Guardian
      </button>
      <button class="tab-btn px-6 py-3 rounded-md hover:bg-gray-100 transition-all text-lg" data-tab="story">
        ğŸ“– Write Story
      </button>
      <button class="tab-btn px-6 py-3 rounded-md hover:bg-gray-100 transition-all text-lg" data-tab="plot">
        ğŸ“ˆ Plot Structure
      </button>
      <div class="ml-auto flex gap-2">
        <button id="copy-text-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
          ğŸ“‹ Copy Text
        </button>
        <button id="export-btn" class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 transition-colors">
          ğŸ“„ Export Story
        </button>
      </div>
    </div>

    <!-- Guardian Creator Tab -->
    <div id="guardian-tab" class="tab-content">
      <div class="grid lg:grid-cols-2 gap-6">
        <!-- Enhanced Guardian Form -->
        <div class="bg-white rounded-lg shadow-sm p-6">
          <h2 class="text-xl font-semibold mb-4 text-sky-700">ğŸŒŠ Design Your Ocean Guardian</h2>
          
          <!-- Character Development Mini-Lesson -->
          <div class="mini-lesson rounded-lg p-4 mb-6">
            <h3 class="font-semibold text-purple-700 mb-2">ğŸ“– Mini-Lesson: Character Development</h3>
            <p class="text-sm mb-3">Great characters have:</p>
            <ul class="text-sm space-y-1 mb-3">
              <li>â€¢ <strong>Personality traits</strong> - What makes them unique?</li>
              <li>â€¢ <strong>Motivations</strong> - What do they want?</li>
              <li>â€¢ <strong>Flaws/Weaknesses</strong> - What challenges them?</li>
              <li>â€¢ <strong>Growth potential</strong> - How can they change?</li>
            </ul>
            <button id="character-lesson-audio" class="bg-purple-100 hover:bg-purple-200 px-3 py-1 rounded text-sm transition-colors">ğŸ”Š Listen to Lesson</button>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Guardian Name</label>
              <input id="guardian-name" type="text" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., Marina the Wave Protector"/>
              <div class="text-xs text-gray-500 mt-1">ğŸ’¡ Tip: Choose a name that reflects their ocean connection</div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ocean Power</label>
              <select id="guardian-power" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                <option value="">Choose a power...</option>
                <option value="wave-control">ğŸŒŠ Wave Control</option>
                <option value="sea-communication">ğŸ‹ Sea Creature Communication</option>
                <option value="water-purification">ğŸ’§ Water Purification</option>
                <option value="coral-healing">ğŸª¸ Coral Healing</option>
                <option value="storm-calming">â›ˆï¸ Storm Calming</option>
                <option value="tide-manipulation">ğŸŒ™ Tide Manipulation</option>
                <option value="deep-sea-navigation">ğŸ—ºï¸ Deep Sea Navigation</option>
                <option value="marine-empathy">ğŸ  Marine Life Empathy</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Guardian's Mission</label>
              <textarea id="guardian-mission" class="w-full border rounded-lg px-3 py-2 h-24 focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="What does your guardian want to protect or achieve?"></textarea>
              <div class="text-xs text-gray-500 mt-1">ğŸ’¡ Think about current ocean threats: pollution, climate change, overfishing</div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Personality Traits</label>
              <div class="grid grid-cols-2 gap-2 mb-2">
                <button class="trait-btn bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded text-sm transition-colors" data-trait="brave">Brave</button>
                <button class="trait-btn bg-green-100 hover:bg-green-200 px-3 py-1 rounded text-sm transition-colors" data-trait="compassionate">Compassionate</button>
                <button class="trait-btn bg-purple-100 hover:bg-purple-200 px-3 py-1 rounded text-sm transition-colors" data-trait="curious">Curious</button>
                <button class="trait-btn bg-yellow-100 hover:bg-yellow-200 px-3 py-1 rounded text-sm transition-colors" data-trait="determined">Determined</button>
                <button class="trait-btn bg-pink-100 hover:bg-pink-200 px-3 py-1 rounded text-sm transition-colors" data-trait="wise">Wise</button>
                <button class="trait-btn bg-indigo-100 hover:bg-indigo-200 px-3 py-1 rounded text-sm transition-colors" data-trait="playful">Playful</button>
              </div>
              <textarea id="guardian-personality" class="w-full border rounded-lg px-3 py-2 h-20 focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Describe your guardian's personality..."></textarea>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Special Abilities</label>
              <textarea id="guardian-abilities" class="w-full border rounded-lg px-3 py-2 h-20 focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="What special skills or tools does your guardian have?"></textarea>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Guardian's Weakness/Challenge</label>
              <input id="guardian-weakness" type="text" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="What challenges does your guardian face?"/>
              <div class="text-xs text-gray-500 mt-1">ğŸ’¡ Weaknesses make characters more relatable and create story tension</div>
            </div>

            <!-- Character Relationship Mapping -->
            <div class="character-map rounded-lg p-4">
              <h3 class="font-semibold text-purple-700 mb-3">ğŸ•¸ï¸ Character Relationships</h3>
              <div class="space-y-2">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Allies (Friends/Helpers)</label>
                  <input id="guardian-allies" type="text" class="w-full border rounded px-3 py-2 text-sm" placeholder="e.g., Wise old turtle, school of dolphins"/>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Mentor (Teacher/Guide)</label>
                  <input id="guardian-mentor" type="text" class="w-full border rounded px-3 py-2 text-sm" placeholder="e.g., Ancient sea spirit, marine biologist"/>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Antagonist (Opponent/Challenge)</label>
                  <input id="guardian-antagonist" type="text" class="w-full border rounded px-3 py-2 text-sm" placeholder="e.g., Pollution monster, greedy corporation"/>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Guardian Preview -->
        <div class="guardian-card rounded-lg p-6">
          <h3 class="text-lg font-semibold mb-4 text-sky-700">ğŸ­ Guardian Preview</h3>
          <div id="guardian-preview" class="space-y-3">
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-2">ğŸŒŠ</div>
              <p>Fill out the form to see your guardian come to life!</p>
            </div>
          </div>
          
          <!-- Character Stats -->
          <div id="character-stats" class="mt-6 hidden">
            <h4 class="font-semibold mb-3">ğŸ“Š Character Development Score</h4>
            <div class="space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-sm">Personality Depth</span>
                <div class="w-24 h-2 bg-gray-200 rounded-full">
                  <div id="personality-bar" class="h-full bg-blue-500 rounded-full transition-all" style="width: 0%"></div>
                </div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm">Motivation Clarity</span>
                <div class="w-24 h-2 bg-gray-200 rounded-full">
                  <div id="motivation-bar" class="h-full bg-green-500 rounded-full transition-all" style="width: 0%"></div>
                </div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm">Relationship Network</span>
                <div class="w-24 h-2 bg-gray-200 rounded-full">
                  <div id="relationship-bar" class="h-full bg-purple-500 rounded-full transition-all" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Guardian Generator -->
          <div class="bg-gradient-to-r from-cyan-50 to-blue-50 border-2 border-cyan-300 rounded-lg p-4 mt-6">
            <h4 class="font-semibold text-cyan-700 mb-3">ğŸ² Guardian Generator</h4>
            <p class="text-xs text-gray-600 mb-3">Need inspiration? Generate a random guardian to get started!</p>
            <button id="generate-guardian-btn" class="w-full bg-cyan-100 hover:bg-cyan-200 px-3 py-2 rounded text-sm transition-colors">ğŸ² Generate Random Guardian</button>
          </div>

          <!-- Multimedia Panel -->
          <div class="multimedia-panel rounded-lg p-4 mt-6">
            <h4 class="font-semibold text-purple-700 mb-3">ğŸ¨ Bring Your Guardian to Life</h4>
            <div class="grid grid-cols-2 gap-2">
              <button id="draw-guardian" class="bg-purple-100 hover:bg-purple-200 px-3 py-2 rounded text-sm transition-colors">âœï¸ Draw Guardian</button>
              <button id="record-voice" class="bg-pink-100 hover:bg-pink-200 px-3 py-2 rounded text-sm transition-colors">ğŸ¤ Record Voice</button>
              <button id="guardian-theme" class="bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded text-sm transition-colors">ğŸµ Choose Theme</button>
              <button id="guardian-animation" class="bg-green-100 hover:bg-green-200 px-3 py-2 rounded text-sm transition-colors">âœ¨ Animate</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="story-tab" class="tab-content hidden">
      <div class="grid lg:grid-cols-3 gap-6">
        <!-- Writing Tools Panel -->
        <div class="writing-tools rounded-lg p-4">
          <h3 class="font-semibold mb-3">âœï¸ Writing Tools</h3>
          <div class="space-y-2">
            <button id="story-prompt-btn" class="w-full bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded text-sm transition-colors">ğŸ’¡ Get Story Prompt</button>
            <button id="word-count-btn" class="w-full bg-green-100 hover:bg-green-200 px-3 py-2 rounded text-sm transition-colors">ğŸ“Š Word Count</button>
            <button id="save-draft-btn" class="w-full bg-yellow-100 hover:bg-yellow-200 px-3 py-2 rounded text-sm transition-colors">ğŸ’¾ Save Draft</button>
            <button id="spell-check-btn" class="w-full bg-purple-100 hover:bg-purple-200 px-3 py-2 rounded text-sm transition-colors">âœ“ Spell Check</button>
          </div>
          
          <!-- Vocabulary Bank -->
          <div class="vocabulary-bank rounded-lg p-3 mt-4">
            <h4 class="font-semibold text-amber-700 mb-2">ğŸ¦ Ocean Vocabulary</h4>
            <div class="grid grid-cols-2 gap-1 text-xs">
              <span class="vocab-word bg-blue-100 px-2 py-1 rounded cursor-pointer hover:bg-blue-200" data-word="mysterious">mysterious</span>
              <span class="vocab-word bg-blue-100 px-2 py-1 rounded cursor-pointer hover:bg-blue-200" data-word="shimmering">shimmering</span>
              <span class="vocab-word bg-blue-100 px-2 py-1 rounded cursor-pointer hover:bg-blue-200" data-word="turbulent">turbulent</span>
              <span class="vocab-word bg-blue-100 px-2 py-1 rounded cursor-pointer hover:bg-blue-200" data-word="serene">serene</span>
              <span class="vocab-word bg-blue-100 px-2 py-1 rounded cursor-pointer hover:bg-blue-200" data-word="coral reef">coral reef</span>
              <span class="vocab-word bg-blue-100 px-2 py-1 rounded cursor-pointer hover:bg-blue-200" data-word="abyss">abyss</span>
            </div>
          </div>

          <!-- Sentence Templates -->
          <div class="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-300 rounded-lg p-3 mt-4">
            <h4 class="font-semibold text-green-700 mb-2">ğŸ“ Sentence Templates</h4>
            <p class="text-xs text-gray-600 mb-3">Get helpful sentence starters with blanks to fill in!</p>
            <button id="template-prompt-btn" class="w-full bg-green-100 hover:bg-green-200 px-3 py-2 rounded text-sm transition-colors">ğŸ“ Get Template Sentences</button>
          </div>
        </div>

        <!-- Main Writing Area -->
        <div class="lg:col-span-2 space-y-4">
          <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold text-sky-700">ğŸ“– Write Your Ocean Guardian Story</h2>
              <div class="text-sm text-gray-500">
                <span id="word-counter">0 words</span> â€¢ <span id="feedback-score" class="text-green-600">Score: 0/100</span>
              </div>
            </div>
            
            <!-- Real-time Feedback Panel -->
            <div id="feedback-panel" class="feedback-panel rounded-lg p-4 mb-4 hidden">
              <h3 class="font-semibold text-amber-700 mb-2">ğŸ’¡ Writing Feedback</h3>
              <div id="feedback-content" class="text-sm space-y-2">
                <!-- Feedback will appear here -->
              </div>
            </div>
            
            <!-- Story Title -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Story Title</label>
              <input id="story-title" type="text" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Give your story an exciting title..."/>
            </div>

            <!-- Story Sections with Literary Terms -->
            <div class="space-y-6">
              <!-- Beginning -->
              <div class="story-element rounded-lg p-4">
                <h3 class="font-semibold text-amber-700 mb-2">ğŸŒ… Beginning - Exposition (Setting the Scene)</h3>
                <div class="literary-term rounded p-2 mb-3">
                  <p class="text-xs font-medium text-amber-800">ğŸ“š Literary Term: <strong>Exposition</strong> - The part of the story where you introduce characters, setting, and background information.</p>
                </div>
                <p class="text-sm text-gray-600 mb-3">Introduce your guardian and the ocean world. What does it look like? What's happening?</p>
                <textarea id="story-beginning" class="w-full border rounded-lg px-3 py-2 h-32 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 writing-panel" placeholder="Once upon a time, in the depths of the ocean..."></textarea>
                <div class="text-xs text-gray-500 mt-1">ğŸ’¡ Tip: Use descriptive words to paint a picture of the underwater world</div>
              </div>

              <!-- Problem/Conflict -->
              <div class="story-element rounded-lg p-4">
                <h3 class="font-semibold text-amber-700 mb-2">âš¡ Problem - Rising Action (The Challenge Appears)</h3>
                <div class="literary-term rounded p-2 mb-3">
                  <p class="text-xs font-medium text-amber-800">ğŸ“š Literary Term: <strong>Rising Action</strong> - The part where the main conflict or problem is introduced and tension builds.</p>
                </div>
                <p class="text-sm text-gray-600 mb-3">What problem does your guardian discover? What threatens the ocean?</p>
                <textarea id="story-problem" class="w-full border rounded-lg px-3 py-2 h-32 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 writing-panel" placeholder="Suddenly, the guardian noticed something was terribly wrong..."></textarea>
                <div class="text-xs text-gray-500 mt-1">ğŸ’¡ Tip: Make the problem feel urgent and important</div>
              </div>

              <!-- Action/Adventure -->
              <div class="story-element rounded-lg p-4">
                <h3 class="font-semibold text-amber-700 mb-2">ğŸƒâ€â™€ï¸ Action - Climax (The Guardian Takes Action)</h3>
                <div class="literary-term rounded p-2 mb-3">
                  <p class="text-xs font-medium text-amber-800">ğŸ“š Literary Term: <strong>Climax</strong> - The most exciting part of the story where the main character faces the biggest challenge.</p>
                </div>
                <p class="text-sm text-gray-600 mb-3">How does your guardian try to solve the problem? What adventures happen?</p>
                <textarea id="story-action" class="w-full border rounded-lg px-3 py-2 h-32 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 writing-panel" placeholder="The guardian knew exactly what to do..."></textarea>
                <div class="text-xs text-gray-500 mt-1">ğŸ’¡ Tip: Show your guardian using their special powers and personality</div>
              </div>

              <!-- Falling Action -->
              <div class="story-element rounded-lg p-4">
                <h3 class="font-semibold text-amber-700 mb-2">ğŸ“‰ After the Action - Falling Action (What Happens Next)</h3>
                <div class="literary-term rounded p-2 mb-3">
                  <p class="text-xs font-medium text-amber-800">ğŸ“š Literary Term: <strong>Falling Action</strong> - Events that happen right after the climax, showing consequences and character reactions.</p>
                </div>
                <p class="text-sm text-gray-600 mb-3">What happens immediately after your guardian's big action? How do others react?</p>
                <textarea id="story-falling" class="w-full border rounded-lg px-3 py-2 h-32 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 writing-panel" placeholder="After the guardian's heroic action, the sea creatures slowly emerged..."></textarea>
                <div class="text-xs text-gray-500 mt-1">ğŸ’¡ Tip: Show the immediate effects and how characters react to what just happened</div>
              </div>

              <!-- Resolution -->
              <div class="story-element rounded-lg p-4">
                <h3 class="font-semibold text-amber-700 mb-2">ğŸŒŸ Ending - Resolution (Problem Solved)</h3>
                <div class="literary-term rounded p-2 mb-3">
                  <p class="text-xs font-medium text-amber-800">ğŸ“š Literary Term: <strong>Resolution</strong> - The ending where conflicts are resolved and loose ends are tied up.</p>
                </div>
                <p class="text-sm text-gray-600 mb-3">How is the problem solved? What happens to your guardian and the ocean?</p>
                <textarea id="story-ending" class="w-full border rounded-lg px-3 py-2 h-32 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 writing-panel" placeholder="In the end, the ocean was safe once again..."></textarea>
                <div class="text-xs text-gray-500 mt-1">ğŸ’¡ Tip: Show how your guardian has grown or what they learned</div>
              </div>
            </div>

            <!-- Story Preview -->
            <div class="mt-6 p-4 bg-sky-50 rounded-lg">
              <h3 class="font-semibold text-sky-700 mb-3">ğŸ“„ Story Preview</h3>
              <div id="story-preview" class="text-sm text-gray-700 space-y-2">
                <p class="italic">Your complete story will appear here as you write...</p>
              </div>
              <button id="read-story-btn" class="mt-3 bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded text-sm transition-colors">ğŸ”Š Read My Story Aloud</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="plot-tab" class="tab-content hidden">
      <div class="grid lg:grid-cols-2 gap-6">
        <!-- Plot Mountain Visual -->
        <div class="bg-white rounded-lg shadow-sm p-6">
          <h2 class="text-xl font-semibold mb-4 text-sky-700">ğŸ“ˆ Story Plot Mountain</h2>
          
          <!-- Plot Mountain Diagram -->
          <div class="plot-mountain rounded-lg p-6 mb-6">
            <svg viewBox="0 0 400 200" class="w-full h-48">
              <!-- Mountain outline -->
              <path d="M 20 180 L 100 120 L 200 40 L 300 120 L 380 180" stroke="#0ea5e9" stroke-width="3" fill="none"/>
              
            <!-- Plot points (now squares) -->
<rect x="13" y="173" width="14" height="14" fill="#22c55e" class="plot-point" data-stage="exposition"/>
<rect x="93" y="113" width="14" height="14" fill="#f59e0b" class="plot-point" data-stage="rising"/>
<rect x="193" y="33" width="14" height="14" fill="#ef4444" class="plot-point" data-stage="climax"/>
<rect x="293" y="113" width="14" height="14" fill="#8b5cf6" class="plot-point" data-stage="falling"/>
<rect x="373" y="173" width="14" height="14" fill="#06b6d4" class="plot-point" data-stage="resolution"/>

              <!-- Labels -->
              <text x="20" y="200" text-anchor="middle" class="text-xs fill-gray-600">Exposition</text>
              <text x="100" y="140" text-anchor="middle" class="text-xs fill-gray-600">Rising Action</text>
              <text x="200" y="25" text-anchor="middle" class="text-xs fill-gray-600">Climax</text>
              <text x="300" y="140" text-anchor="middle" class="text-xs fill-gray-600">Falling Action</text>
              <text x="380" y="200" text-anchor="middle" class="text-xs fill-gray-600">Resolution</text>
            </svg>
          </div>
          
          <!-- Plot Stage Feedback -->
          <div id="plot-feedback" class="space-y-3">
            <div class="text-center text-gray-500">
              <p>Click on a plot point above to see feedback for that story stage!</p>
            </div>
          </div>
        </div>

        <!-- Plot Analysis -->
        <div class="bg-white rounded-lg shadow-sm p-6">
          <h3 class="text-lg font-semibold mb-4 text-sky-700">ğŸ” Story Analysis</h3>
          
          <!-- Story Strength Indicators -->
          <div class="space-y-4">
            <div class="writing-strength rounded-lg p-3">
              <h4 class="font-semibold text-green-700 mb-2">âœ… Story Strengths</h4>
              <div id="story-strengths" class="text-sm space-y-1">
                <p class="text-gray-500">Write your story to see strengths appear here!</p>
              </div>
            </div>
            
            <div class="writing-improvement rounded-lg p-3">
              <h4 class="font-semibold text-amber-700 mb-2">ğŸ’¡ Areas to Improve</h4>
              <div id="story-improvements" class="text-sm space-y-1">
                <p class="text-gray-500">Suggestions will appear as you write!</p>
              </div>
            </div>
            
            <!-- Plot Completeness Chart -->
            <div class="feedback-score rounded-lg p-4">
              <h4 class="font-semibold text-sky-700 mb-3">ğŸ“Š Plot Completeness</h4>
              <div class="space-y-2">
                <div class="flex justify-between items-center">
                  <span class="text-sm">Exposition</span>
                  <div class="w-24 h-2 bg-gray-200 rounded-full">
                    <div id="beginning-progress" class="h-full bg-green-500 rounded-full transition-all" style="width: 0%"></div>
                  </div>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm">Rising Action</span>
                  <div class="w-24 h-2 bg-gray-200 rounded-full">
                    <div id="problem-progress" class="h-full bg-yellow-500 rounded-full transition-all" style="width: 0%"></div>
                  </div>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm">Climax</span>
                  <div class="w-24 h-2 bg-gray-200 rounded-full">
                    <div id="action-progress" class="h-full bg-red-500 rounded-full transition-all" style="width: 0%"></div>
                  </div>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm">Falling Action</span>
                  <div class="w-24 h-2 bg-gray-200 rounded-full">
                    <div id="falling-progress" class="h-full bg-purple-500 rounded-full transition-all" style="width: 0%"></div>
                  </div>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm">Resolution</span>
                  <div class="w-24 h-2 bg-gray-200 rounded-full">
                    <div id="ending-progress" class="h-full bg-blue-500 rounded-full transition-all" style="width: 0%"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


  </main>

  <script>
    // Global variables
    let currentTab = 'guardian';
    let __dirty = false; let __lastSave = 0;
    
    

// --- helpers: non-blocking info + safe speech ---
function showInfo(message) {
  try {
    let el = document.getElementById('focus-alert');
    if (!el) {
      el = document.createElement('div');
      el.id = 'focus-alert';
      el.style.cssText = 'position:fixed;top:10px;right:10px;background:#0ea5e9;color:#fff;padding:8px 12px;border-radius:8px;font-size:14px;display:none;z-index:100;';
      document.body.appendChild(el);
    }
    el.textContent = message;
    el.style.display = 'block';
    clearTimeout(window.__toastHideTimer);
    window.__toastHideTimer = setTimeout(() => { el.style.display = 'none'; }, 2200);
  } catch (e) {
    try { alert(message); } catch {}
  }
}

function safeSpeak(text, opts = {}) {
  try {
    if (!('speechSynthesis' in window)) throw new Error('no-tts');
    const u = new SpeechSynthesisUtterance(text);
    if (opts.rate) u.rate = opts.rate;
    if (opts.pitch) u.pitch = opts.pitch;
    if (opts.lang) u.lang = opts.lang;
    speechSynthesis.speak(u);
    return true;
  } catch (e) {
    showInfo('ğŸ”‡ Text-to-speech is not supported on this device.');
    return false;
  }
}


// Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Page loaded, initializing...');
      
      // Load any saved data first
      loadSavedStory();
      
      // Initialize all functionality
      initializeTabs();
      initializeGuardianForm();
      initializeStoryWriting();
      
      setupWordTargets();
initializePlotPoints();
      initializeAccessibility();
      initializeFocusMode();
      initializeExport();
      initializeCopyText();
      initializeTutorial();
      
      console.log('All systems initialized');
    });


// --- Keyboard shortcuts ---
document.addEventListener('keydown', function(e) {
  try {
    // Ctrl+S => save
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
      e.preventDefault();
      saveStoryData();
      const now = new Date();
      const ts = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      const ss = document.getElementById('save-status');
      if (ss) ss.textContent = 'Saved â€¢ ' + ts;
      showInfo('Saved â€¢ ' + ts);
    }
    // Ctrl+Enter => next tab
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      const order = ['guardian', 'story', 'plot'];
      const idx = order.indexOf(currentTab);
      const next = order[(idx + 1) % order.length];
      const btn = document.querySelector('.tab-btn[data-tab="' + next + '"]');
      if (btn) btn.click();
    }
  } catch (err) {}
});


    // Tab switching - Completely rewritten
    function initializeTabs() {
      console.log('Initializing tabs...');
      
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      
      console.log('Found', tabButtons.length, 'tab buttons');
      console.log('Found', tabContents.length, 'tab contents');
      
      tabButtons.forEach(function(button, index) {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          
          const targetTab = button.getAttribute('data-tab');
          console.log('Switching to tab:', targetTab);
          
          // Remove active class from all buttons
          tabButtons.forEach(function(btn) {
            btn.classList.remove('tab-active');
            btn.classList.add('hover:bg-gray-100');
          });
          
          // Add active class to clicked button
          button.classList.add('tab-active');
          button.classList.remove('hover:bg-gray-100');
          
          // Hide all tab contents
          tabContents.forEach(function(content) {
            content.classList.add('hidden');
          });
          
          // Show target tab content
          const targetContent = document.getElementById(targetTab + '-tab');
          if (targetContent) {
            targetContent.classList.remove('hidden');
            console.log('Showed tab:', targetTab);
          } else {
            console.error('Could not find tab content for:', targetTab);
          }
          
          currentTab = targetTab;
        });
      });
      
      console.log('Tab system initialized');
    }

    // Guardian form functionality
    function initializeGuardianForm() {
      console.log('Initializing guardian form...');
      
      // Guardian form inputs
      const guardianInputs = [
        'guardian-name', 'guardian-power', 'guardian-mission', 
        'guardian-personality', 'guardian-abilities', 'guardian-weakness',
        'guardian-allies', 'guardian-mentor', 'guardian-antagonist'
      ];
      
      guardianInputs.forEach(function(inputId) {
        const element = document.getElementById(inputId);
        if (element) {
          element.addEventListener('input', () => { updateGuardianPreview(); saveStoryData(); });
          element.addEventListener('change', () => { updateGuardianPreview(); saveStoryData(); });
        }
      });

      // Trait buttons
      const traitButtons = document.querySelectorAll('.trait-btn');
      traitButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          const trait = btn.getAttribute('data-trait');
          const personalityField = document.getElementById('guardian-personality');
          const currentText = personalityField.value;
          
          if (!currentText.includes(trait)) {
            personalityField.value = currentText ? currentText + ', ' + trait : trait;
            updateGuardianPreview();
          }
        });
      });

      // Guardian generator
      const generateBtn = document.getElementById('generate-guardian-btn');
      if (generateBtn) {
        generateBtn.addEventListener('click', generateRandomGuardian);
      }

      // Multimedia buttons
      setupMultimediaButtons();
      
      
      // Mark dirty on guardian inputs
      guardianInputs.forEach(function(inputId) {
        const element = document.getElementById(inputId);
        if (element) { element.addEventListener('input', function(){ __dirty = true; }); }
      });
    // __guardian_dirty_marker__
    
      console.log('Guardian form initialized');
    }

    function updateGuardianPreview() {
      const name = document.getElementById('guardian-name').value;
      const power = document.getElementById('guardian-power').value;
      const mission = document.getElementById('guardian-mission').value;
      const personality = document.getElementById('guardian-personality').value;
      const abilities = document.getElementById('guardian-abilities').value;
      const weakness = document.getElementById('guardian-weakness').value;
      
      const preview = document.getElementById('guardian-preview');
      
      if (name || power || mission) {
        const powerEmojis = {
          'wave-control': 'ğŸŒŠ',
          'sea-communication': 'ğŸ‹',
          'water-purification': 'ğŸ’§',
          'coral-healing': 'ğŸª¸',
          'storm-calming': 'â›ˆï¸',
          'tide-manipulation': 'ğŸŒ™',
          'deep-sea-navigation': 'ğŸ—ºï¸',
          'marine-empathy': 'ğŸ '
        };
        
        let powerText = '';
        if (power) {
          const powerOption = document.querySelector('option[value="' + power + '"]');
          powerText = powerOption ? powerOption.textContent : power;
        }
        
        preview.innerHTML = 
          '<div class="text-center mb-4">' +
            '<div class="text-4xl mb-2">' + (powerEmojis[power] || 'ğŸŒŠ') + '</div>' +
            '<h3 class="text-lg font-semibold text-sky-700">' + (name || 'Your Guardian') + '</h3>' +
          '</div>' +
          (power ? '<div class="mb-2"><strong>Power:</strong> ' + powerText + '</div>' : '') +
          (mission ? '<div class="mb-2"><strong>Mission:</strong> ' + mission + '</div>' : '') +
          (personality ? '<div class="mb-2"><strong>Personality:</strong> ' + personality + '</div>' : '') +
          (abilities ? '<div class="mb-2"><strong>Abilities:</strong> ' + abilities + '</div>' : '') +
          (weakness ? '<div class="mb-2"><strong>Challenge:</strong> ' + weakness + '</div>' : '');
        
        // Show character stats
        document.getElementById('character-stats').classList.remove('hidden');
        updateCharacterStats();
      } else {
        preview.innerHTML = 
          '<div class="text-center py-8 text-gray-500">' +
            '<div class="text-4xl mb-2">ğŸŒŠ</div>' +
            '<p>Fill out the form to see your guardian come to life!</p>' +
          '</div>';
        document.getElementById('character-stats').classList.add('hidden');
      }
    }

    function updateCharacterStats() {
      const personality = document.getElementById('guardian-personality').value;
      const mission = document.getElementById('guardian-mission').value;
      const allies = document.getElementById('guardian-allies').value;
      const mentor = document.getElementById('guardian-mentor').value;
      const antagonist = document.getElementById('guardian-antagonist').value;
      
      const personalityScore = personality ? Math.min(100, personality.length * 2) : 0;
      const motivationScore = mission ? Math.min(100, mission.length * 1.5) : 0;
      function countItems(s){ return s.split(',').map(x=>x.trim()).filter(Boolean).length; }
      const relationshipItems = countItems(allies) + countItems(mentor) + countItems(antagonist);
      const relationshipScore = Math.min(100, relationshipItems * 20);
      document.getElementById('personality-bar').style.width = personalityScore + '%';
      document.getElementById('motivation-bar').style.width = motivationScore + '%';
      document.getElementById('relationship-bar').style.width = relationshipScore + '%';
    }

    function generateRandomGuardian() {
      const guardianNames = [
        "Marina the Wave Protector", "Coral the Reef Guardian", "Aqua the Deep Sea Defender", 
        "Neptune the Storm Calmer", "Pearl the Ocean Healer", "Tide the Current Master"
      ];
      
      const powers = [
        "wave-control", "sea-communication", "water-purification", "coral-healing"
      ];
      
      const missions = [
        "Protecting coral reefs from bleaching and pollution",
        "Cleaning plastic waste from the ocean depths",
        "Guiding lost sea creatures back to their families",
        "Stopping illegal fishing and protecting marine life"
      ];
      
      const personalities = [
        "brave and determined, never backing down from a challenge",
        "wise and patient, always thinking before acting",
        "playful and curious, finding joy in helping others",
        "compassionate and gentle, caring deeply for all sea life"
      ];
      
      const abilities = [
        "Can breathe underwater indefinitely and swim at incredible speeds",
        "Speaks all ocean languages and commands respect from sea creatures",
        "Controls water temperature and can create healing currents",
        "Summons protective barriers made of crystallized seawater"
      ];
      
      const weaknesses = [
        "Loses power when away from water for too long",
        "Cannot use abilities during solar eclipses",
        "Becomes weak when the ocean is heavily polluted",
        "Must return to their home reef to recharge monthly"
      ];
      
      // Fill in random values
      document.getElementById('guardian-name').value = guardianNames[Math.floor(Math.random() * guardianNames.length)];
      document.getElementById('guardian-power').value = powers[Math.floor(Math.random() * powers.length)];
      document.getElementById('guardian-mission').value = missions[Math.floor(Math.random() * missions.length)];
      document.getElementById('guardian-personality').value = personalities[Math.floor(Math.random() * personalities.length)];
      document.getElementById('guardian-abilities').value = abilities[Math.floor(Math.random() * abilities.length)];
      document.getElementById('guardian-weakness').value = weaknesses[Math.floor(Math.random() * weaknesses.length)];
      
      // Add some relationships
      const allies = ["A wise old sea turtle", "A school of helpful dolphins", "A family of protective whales"];
      const mentors = ["An ancient sea spirit", "The Ocean Mother herself", "A legendary guardian from the past"];
      const antagonists = ["A pollution-spreading corporation", "A greedy fishing fleet", "A mysterious dark current"];
      
      document.getElementById('guardian-allies').value = allies[Math.floor(Math.random() * allies.length)];
      document.getElementById('guardian-mentor').value = mentors[Math.floor(Math.random() * mentors.length)];
      document.getElementById('guardian-antagonist').value = antagonists[Math.floor(Math.random() * antagonists.length)];
      
      updateGuardianPreview();
      
      // Show feedback
      const btn = document.getElementById('generate-guardian-btn');
      const originalText = btn.textContent;
      btn.textContent = 'âœ¨ Guardian Generated!';
      btn.classList.add('bg-green-200');
      setTimeout(function() {
        btn.textContent = originalText;
        btn.classList.remove('bg-green-200');
      }, 2000);
    }

    function setupMultimediaButtons() {
      const buttons = [
        { id: 'draw-guardian', message: 'Drawing feature coming soon! For now, describe your guardian in the text fields.' },
        { id: 'record-voice', message: 'Voice recording feature coming soon! Try using the text-to-speech feature instead.' },
        { id: 'guardian-theme', message: 'Theme music feature coming soon! Imagine what your guardian\'s theme would sound like.' },
        { id: 'guardian-animation', message: 'Animation feature coming soon! For now, visualize how your guardian moves and acts.' }
      ];
      
      buttons.forEach(function(btn) {
        const element = document.getElementById(btn.id);
        if (element) {
          element.addEventListener('click', function() {
            showInfo(btn.message);
          });
        }
      });

      // Character lesson audio
      const lessonBtn = document.getElementById('character-lesson-audio');
      if (lessonBtn) {
        lessonBtn.addEventListener('click', function() {
          const lessonText = "Great characters have personality traits that make them unique, motivations that drive their actions, flaws that create challenges, and growth potential that allows them to change throughout the story.";
            if (!safeSpeak(lessonText, { rate: 1 })) { showInfo('Text-to-speech is not supported in your browser.'); }
        });
      }
    }

    
// --- Word targets UI ---
const WORD_TARGETS = {
  'story-beginning': [80, 120],
  'story-problem': [80, 120],
  'story-action': [120, 160],
  'story-falling': [60, 120],
  'story-ending': [60, 120],
};

function setupWordTargets() {
  const ids = Object.keys(WORD_TARGETS);
  ids.forEach(id => {
    const ta = document.getElementById(id);
    if (!ta) return;
    const statusId = 'wc-' + id;
    if (!document.getElementById(statusId)) {
      const [min,max] = WORD_TARGETS[id];
      const div = document.createElement('div');
      div.id = statusId;
      div.className = 'text-xs text-gray-500 mt-1';
      div.textContent = `Target ${min}â€“${max} words â€¢ 0 words`;
      ta.insertAdjacentElement('afterend', div);
    }
  });
}


    // Story writing functionality
    function initializeStoryWriting() {
      console.log('Initializing story writing...');
      
      // Story input fields
      const storyInputs = ['story-title', 'story-beginning', 'story-problem', 'story-action', 'story-falling', 'story-ending'];
      
      storyInputs.forEach(function(inputId) {
        const element = document.getElementById(inputId);
        if (element) {
          element.addEventListener('input', function() {
            updateWordCount();
            updateStoryPreview();
            
          if (typeof updatePlotProgress === 'function') { updatePlotProgress(); }
          updatePlotProgress();
            saveStoryData();
          });
          element.addEventListener('focus', function() {
            window.lastFocusedTextarea = element;
          });
        }
      });

      // Writing tool buttons
      setupWritingTools();
      setupVocabularyBank();
      
      
      // Mark dirty on story inputs
      storyInputs.forEach(function(inputId) {
        const element = document.getElementById(inputId);
        if (element) { element.addEventListener('input', function(){ __dirty = true; }); }
      });
    
      console.log('Story writing initialized');
    }

    function setupWritingTools() {
      // Story prompt button
      const storyPromptBtn = document.getElementById('story-prompt-btn');
      if (storyPromptBtn) {
        storyPromptBtn.addEventListener('click', function() {
          const prompts = [
            "Your guardian discovers plastic pollution threatening a coral reef. What do they do first?",
            "A mysterious oil spill appears overnight in your guardian's territory. How do they investigate?",
            "Sea creatures are disappearing and your guardian must find out why. Where do they start looking?",
            "Your guardian meets a young whale who has lost their family. How can they help?"
          ];
          const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
          
          showPromptModal(randomPrompt);
        });
      }

      // Word count button
      const wordCountBtn = document.getElementById('word-count-btn');
      if (wordCountBtn) {
        wordCountBtn.addEventListener('click', function() {
          updateWordCount();
          const count = document.getElementById('word-counter').textContent;
          
          const textareas = ['story-beginning', 'story-problem', 'story-action', 'story-ending'];
          let details = '';
          textareas.forEach(function(id) {
            const element = document.getElementById(id);
            if (element && element.value) {
              const words = element.value.trim().split(/\s+/).filter(function(word) { return word.length > 0; }).length;
              const sectionName = id.replace('story-', '').replace('-', ' ');
              details += sectionName + ': ' + words + ' words\n';
            }
          });
          
          alert('ğŸ“Š Word Count Details:\n\nTotal: ' + count + '\n\n' + details);
        });
      }

      // Save draft button
      const saveDraftBtn = document.getElementById('save-draft-btn');
      if (saveDraftBtn) {
        saveDraftBtn.addEventListener('click', function() {
          saveStoryData();
          
          const saveBtn = document.getElementById('save-draft-btn');
          const originalText = saveBtn.textContent;
          saveBtn.textContent = 'âœ… Saved!';
          saveBtn.classList.add('bg-green-200');
          
          alert('ğŸ’¾ Story Saved Successfully!\n\nğŸ“ Your story is saved locally in your browser.\nğŸ”„ It will automatically load when you return.\nğŸ“¤ Use "Export Story" to download a file.');
          
          setTimeout(function() {
            saveBtn.textContent = originalText;
            saveBtn.classList.remove('bg-green-200');
          }, 2000);
        });
      }

      // Spell check button
      const spellCheckBtn = document.getElementById('spell-check-btn');
      if (spellCheckBtn) {
        spellCheckBtn.addEventListener('click', function() {
          alert('âœ“ Spell Check Complete!\n\nCheck for:\nâ€¢ Capital letters at sentence starts\nâ€¢ Double spaces\nâ€¢ Spelling of ocean words\n\nTip: Read your story aloud to catch more errors!');
        });
      }

      // Read story button
      const readStoryBtn = document.getElementById('read-story-btn');
      if (readStoryBtn) {
        readStoryBtn.addEventListener('click', function() {
          if ('speechSynthesis' in window) {
            const title = document.getElementById('story-title').value;
            const beginning = document.getElementById('story-beginning').value;
            const problem = document.getElementById('story-problem').value;
            const action = document.getElementById('story-action').value;
            const falling = document.getElementById('story-falling').value;
            const ending = document.getElementById('story-ending').value;
            
            const fullStory = [title, beginning, problem, action, falling, ending].filter(function(text) { return text.trim(); }).join(' ');
            
            if (fullStory) {
              const utterance = new SpeechSynthesisUtterance(fullStory);
              utterance.rate = 0.8;
              speechSynthesis.speak(utterance);
            } else {
              alert('Write some of your story first, then I can read it aloud!');
            }
          } else {
            alert('Text-to-speech is not supported in your browser.');
          }
        });
      }

      // Template prompt button
      const templateBtn = document.getElementById('template-prompt-btn');
      if (templateBtn) {
        templateBtn.addEventListener('click', showTemplateModal);
      }
    }

    function setupVocabularyBank() {
      const vocabWords = document.querySelectorAll('.vocab-word');
      vocabWords.forEach(function(wordSpan) {
        wordSpan.addEventListener('click', function() {
          const word = wordSpan.getAttribute('data-word');
          insertWord(word);
        });
      });
    }

    function insertWord(word) {
      let targetBox = document.activeElement;
      
      if (!targetBox || targetBox.tagName !== 'TEXTAREA') {
        targetBox = window.lastFocusedTextarea || document.getElementById('story-beginning');
      }
      
      if (targetBox && targetBox.tagName === 'TEXTAREA') {
        const start = targetBox.selectionStart || targetBox.value.length;
        const end = targetBox.selectionEnd || targetBox.value.length;
        const text = targetBox.value;
        
        const needsSpace = text.length > 0 && !text.endsWith(' ') && !text.endsWith('\n');
        const wordToInsert = needsSpace ? ' ' + word : word;
        
        const newText = text.substring(0, start) + wordToInsert + text.substring(end);
        targetBox.value = newText;
        
        const newPosition = start + wordToInsert.length;
        targetBox.selectionStart = targetBox.selectionEnd = newPosition;
        targetBox.focus();
        
        // Trigger input event
        const inputEvent = new Event('input', { bubbles: true });
        targetBox.dispatchEvent(inputEvent);
        
        return true;
      } else {
        alert('Click in a writing box first, then click "' + word + '" to add it to your story!');
        return false;
      }
    }

    function showPromptModal(prompt) {
      const modal = document.createElement('div');
      modal.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-xl border-2 border-sky-500 z-50 max-w-md';
      modal.innerHTML = 
        '<h3 class="font-semibold text-sky-700 mb-3">ğŸ’¡ Story Prompt</h3>' +
        '<p class="text-gray-700 mb-4">' + prompt + '</p>' +
        '<div class="flex gap-2">' +
          '<button class="use-prompt-btn bg-sky-600 text-white px-4 py-2 rounded hover:bg-sky-700">Use This Prompt</button>' +
          '<button class="close-prompt-btn bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Close</button>' +
        '</div>';
      
      document.body.appendChild(modal);
      
      modal.querySelector('.use-prompt-btn').addEventListener('click', function() {
        const targetBox = document.getElementById('story-beginning');
        if (targetBox.value.trim() === '') {
          targetBox.value = prompt;
        } else {
          targetBox.value += ' ' + prompt;
        }
        targetBox.focus();
        updateWordCount();
        updateStoryPreview();
        document.body.removeChild(modal);
      });
      
      modal.querySelector('.close-prompt-btn').addEventListener('click', function() {
        document.body.removeChild(modal);
      });
    }

    function showTemplateModal() {
      const templates = {
        beginning: [
          "Deep in the _____ ocean, there lived a guardian named _____.",
          "The _____ waves sparkled as _____ swam through the coral reef."
        ],
        problem: [
          "Suddenly, _____ noticed that the water was turning _____.",
          "The sea creatures were _____ because _____."
        ],
        action: [
          "_____ used their power to _____ and save the day.",
          "Working together with _____, the guardian was able to _____."
        ],
        ending: [
          "Thanks to _____, the ocean was _____ once again.",
          "_____ learned that _____ and promised to always protect the sea."
        ]
      };

      const modal = document.createElement('div');
      modal.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-xl border-2 border-green-500 z-50 max-w-lg max-h-96 overflow-y-auto';
      
      let templateHTML = 
        '<h3 class="font-semibold text-green-700 mb-3">ğŸ“ Sentence Templates</h3>' +
        '<p class="text-sm text-gray-600 mb-4">Choose a template to help structure your story. Fill in the blanks (____) with your own words!</p>' +
        '<div class="space-y-4">';
      
      Object.keys(templates).forEach(function(section) {
        const sectionName = section.charAt(0).toUpperCase() + section.slice(1);
        templateHTML += '<div><h4 class="font-medium mb-2">' + sectionName + ' Templates:</h4>';
        templates[section].forEach(function(template) {
          templateHTML += '<button class="template-btn block w-full text-left bg-gray-50 hover:bg-gray-100 px-3 py-2 rounded text-sm mb-1 border" data-template="' + template + '" data-section="' + section + '">' + template + '</button>';
        });
        templateHTML += '</div>';
      });
      
      templateHTML += '</div><div class="flex justify-end mt-4"><button class="close-templates-btn bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Close</button></div>';
      
      modal.innerHTML = templateHTML;
      document.body.appendChild(modal);
      
      modal.querySelectorAll('.template-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          const template = btn.getAttribute('data-template');
          const section = btn.getAttribute('data-section');
          
          let targetBox;
          if (section === 'beginning') targetBox = document.getElementById('story-beginning');
          else if (section === 'problem') targetBox = document.getElementById('story-problem');
          else if (section === 'action') targetBox = document.getElementById('story-action');
          else if (section === 'ending') targetBox = document.getElementById('story-ending');
          
          if (targetBox) {
            if (targetBox.value.trim() === '') {
              targetBox.value = template;
            } else {
              targetBox.value += ' ' + template;
            }
            targetBox.focus();
            
            const firstBlank = targetBox.value.indexOf('_____');
            if (firstBlank !== -1) {
              targetBox.setSelectionRange(firstBlank, firstBlank + 5);
            }
            
            updateWordCount();
            updateStoryPreview();
          }
          
          document.body.removeChild(modal);
        });
      });
      
      modal.querySelector('.close-templates-btn').addEventListener('click', function() {
        document.body.removeChild(modal);
      });
    }

    function updateWordCount() {
      const textareas = ['story-beginning', 'story-problem', 'story-action', 'story-falling', 'story-ending'];
      let totalWords = 0;
      
      textareas.forEach(function(id) {
        const element = document.getElementById(id);
        if (element && element.value) {
          totalWords += element.value.trim().split(/\s+/).filter(function(word) { return word.length > 0; }).length;
        }
      });
      
      document.getElementById('word-counter').textContent = totalWords + ' words';

      // Update per-section counters against targets
      textareas.forEach(function(id) {
        const el = document.getElementById(id);
        const status = document.getElementById('wc-' + id);
        if (!el || !status) return;
        const words = el.value ? el.value.trim().split(/\s+/).filter(w => w.length>0).length : 0;
        const tgt = WORD_TARGETS[id];
        if (tgt) {
          const within = words >= tgt[0] && words <= tgt[1];
          status.textContent = `Target ${tgt[0]}â€“${tgt[1]} words â€¢ ${words} words` + (within ? ' âœ“' : '');
        } else {
          status.textContent = `${words} words`;
        }
      });
    
      updateWritingFeedback();
    }

    function updateWritingFeedback() {
      const beginning = document.getElementById('story-beginning').value;
      const problem = document.getElementById('story-problem').value;
      const action = document.getElementById('story-action').value;
      const falling = document.getElementById('story-falling').value;
      const ending = document.getElementById('story-ending').value;
      
      const feedbackPanel = document.getElementById('feedback-panel');
      const feedbackContent = document.getElementById('feedback-content');
      const feedbackScore = document.getElementById('feedback-score');
      
      let feedback = [];
      let score = 0;
      
      if (beginning.length > 20) {
        score += 20;
        if (beginning.toLowerCase().includes('ocean') || beginning.toLowerCase().includes('sea')) {
          feedback.push('âœ… Great job setting the ocean scene!');
          score += 5;
        }
      }
      
      if (problem.length > 20) {
        score += 20;
        if (problem.toLowerCase().includes('pollution') || problem.toLowerCase().includes('danger')) {
          feedback.push('âœ… You\'ve identified a clear ocean threat!');
          score += 5;
        }
      }
      
      if (action.length > 20) {
        score += 15;
        const guardianName = document.getElementById('guardian-name').value;
        if (guardianName && action.toLowerCase().includes(guardianName.toLowerCase().split(' ')[0])) {
          feedback.push('âœ… Your guardian is the hero of the story!');
          score += 5;
        }
      }
      
      if (falling.length > 20) {
        score += 15;
        if (falling.toLowerCase().includes('react') || falling.toLowerCase().includes('effect') || falling.toLowerCase().includes('result')) {
          feedback.push('âœ… Great falling action showing consequences!');
          score += 5;
        }
      }
      
      if (ending.length > 20) {
        score += 15;
        if (ending.toLowerCase().includes('safe') || ending.toLowerCase().includes('saved')) {
          feedback.push('âœ… Satisfying ending - the ocean is safe!');
          score += 5;
        }
      }
      
      if (beginning && problem && action && falling && ending) {
        score += 10;
        feedback.push('âœ… Complete story with all plot elements!');
      }
      
      if (feedback.length > 0) {
        feedbackPanel.classList.remove('hidden');
        feedbackContent.innerHTML = feedback.map(function(f) { return '<p>' + f + '</p>'; }).join('');
      } else {
        feedbackPanel.classList.add('hidden');
      }
      
      feedbackScore.textContent = 'Score: ' + Math.min(score, 100) + '/100';
      feedbackScore.className = score >= 80 ? 'text-green-600' : score >= 60 ? 'text-yellow-600' : 'text-red-600';
    }

    function updateStoryPreview() {
      const title = document.getElementById('story-title').value;
      const beginning = document.getElementById('story-beginning').value;
      const problem = document.getElementById('story-problem').value;
      const action = document.getElementById('story-action').value;
      const falling = document.getElementById('story-falling').value;
      const ending = document.getElementById('story-ending').value;
      
      const preview = document.getElementById('story-preview');
      
      if (title || beginning || problem || action || falling || ending) {
        let storyText = '';
        if (title) storyText += '<h4 class="font-semibold text-sky-700 mb-2">' + title + '</h4>';
        if (beginning) storyText += '<p>' + beginning + '</p>';
        if (problem) storyText += '<p>' + problem + '</p>';
        if (action) storyText += '<p>' + action + '</p>';
        if (falling) storyText += '<p>' + falling + '</p>';
        if (ending) storyText += '<p>' + ending + '</p>';
        
        preview.innerHTML = storyText || '<p class="italic">Your complete story will appear here as you write...</p>';
      } else {
        preview.innerHTML = '<p class="italic">Your complete story will appear here as you write...</p>';
      }
    }

    function updatePlotProgress() {
      const sections = {
        'beginning': document.getElementById('story-beginning').value,
        'problem': document.getElementById('story-problem').value,
        'action': document.getElementById('story-action').value,
        'falling': document.getElementById('story-falling').value,
        'ending': document.getElementById('story-ending').value
      };
      
      Object.keys(sections).forEach(function(section) {
        const text = sections[section];
        const progressBar = document.getElementById(section + '-progress');
        if (progressBar) {
          let progress = 0;
          if (text.length > 10) progress = 25;
          if (text.length > 50) progress = 50;
          if (text.length > 100) progress = 75;
          if (text.length > 150) progress = 100;
          
          progressBar.style.width = progress + '%';
        }
      });
      
      updateStoryAnalysis();
    }

    function updateStoryAnalysis() {
      const beginning = document.getElementById('story-beginning').value;
      const problem = document.getElementById('story-problem').value;
      const action = document.getElementById('story-action').value;
      const falling = document.getElementById('story-falling').value;
      const ending = document.getElementById('story-ending').value;
      
      const strengthsDiv = document.getElementById('story-strengths');
      const improvementsDiv = document.getElementById('story-improvements');
      
      let strengths = [];
      let improvements = [];
      
      if (beginning.length > 100) strengths.push('â€¢ Rich, detailed exposition');
      if (problem.length > 50) strengths.push('â€¢ Clear conflict development');
      if (action.length > 100) strengths.push('â€¢ Exciting climax sequence');
      if (falling.length > 50) strengths.push('â€¢ Well-developed falling action');
      if (ending.length > 50) strengths.push('â€¢ Satisfying resolution');
      
      if (beginning.length < 50) improvements.push('â€¢ Add more details to your beginning');
      if (problem.length < 30) improvements.push('â€¢ Make your problem more dramatic');
      if (action.length < 50) improvements.push('â€¢ Show more action in your climax');
      if (falling.length < 30) improvements.push('â€¢ Develop your falling action more');
      if (ending.length < 30) improvements.push('â€¢ Expand your ending');
      
      strengthsDiv.innerHTML = strengths.length > 0 ? strengths.join('<br>') : '<p class="text-gray-500">Keep writing to see your strengths!</p>';
      improvementsDiv.innerHTML = improvements.length > 0 ? improvements.join('<br>') : '<p class="text-gray-500">Great job! No major improvements needed.</p>';
    }

    function showFullStoryAnalysis() {
      const storyData = {
        title: document.getElementById('story-title').value,
        beginning: document.getElementById('story-beginning').value,
        problem: document.getElementById('story-problem').value,
        action: document.getElementById('story-action').value,
        falling: document.getElementById('story-falling').value,
        ending: document.getElementById('story-ending').value
      };
      
      const guardianData = {
        name: document.getElementById('guardian-name').value,
        power: document.getElementById('guardian-power').value,
        mission: document.getElementById('guardian-mission').value
      };
      
      // Calculate comprehensive metrics
      const totalWords = Object.values(storyData).join(' ').trim().split(/\s+/).filter(word => word.length > 0).length;
      const sectionsCompleted = Object.values(storyData).filter(section => section.trim().length > 0).length;
      const completionPercentage = Math.round((sectionsCompleted / 6) * 100);
      
      // Analyze story structure
      let structureScore = 0;
      let structureAnalysis = [];
      
      if (storyData.beginning.length > 30) {
        structureScore += 20;
        structureAnalysis.push('âœ… Strong exposition foundation');
      } else {
        structureAnalysis.push('âŒ Exposition needs development');
      }
      
      if (storyData.problem.length > 30) {
        structureScore += 20;
        structureAnalysis.push('âœ… Clear rising action');
      } else {
        structureAnalysis.push('âŒ Rising action needs work');
      }
      
      if (storyData.action.length > 30) {
        structureScore += 30;
        structureAnalysis.push('âœ… Engaging climax present');
      } else {
        structureAnalysis.push('âŒ Climax needs more excitement');
      }
      
      if (storyData.ending.length > 30) {
        structureScore += 20;
        structureAnalysis.push('âœ… Satisfying resolution');
      } else {
        structureAnalysis.push('âŒ Resolution needs expansion');
      }
      
      if (storyData.title.length > 0) {
        structureScore += 10;
        structureAnalysis.push('âœ… Story has a title');
      }
      
      // Character integration analysis
      let characterScore = 0;
      let characterAnalysis = [];
      
      const fullStory = Object.values(storyData).join(' ').toLowerCase();
      
      if (guardianData.name && fullStory.includes(guardianData.name.toLowerCase().split(' ')[0])) {
        characterScore += 25;
        characterAnalysis.push('âœ… Guardian character appears in story');
      } else if (guardianData.name) {
        characterAnalysis.push('âŒ Guardian ' + guardianData.name + ' should appear more in the story');
      }
      
      if (guardianData.power && fullStory.includes('power')) {
        characterScore += 25;
        characterAnalysis.push('âœ… Guardian uses their powers');
      } else if (guardianData.power) {
        characterAnalysis.push('âŒ Show your guardian using their ' + guardianData.power + ' power');
      }
      
      if (fullStory.includes('ocean') || fullStory.includes('sea')) {
        characterScore += 25;
        characterAnalysis.push('âœ… Strong ocean setting');
      } else {
        characterAnalysis.push('âŒ Add more ocean/underwater details');
      }
      
      if (fullStory.includes('learn') || fullStory.includes('grew') || fullStory.includes('changed')) {
        characterScore += 25;
        characterAnalysis.push('âœ… Character growth shown');
      } else {
        characterAnalysis.push('âŒ Show how your guardian learns or grows');
      }
      
      // Environmental theme analysis
      let themeScore = 0;
      let themeAnalysis = [];
      
      const environmentalWords = ['pollution', 'protect', 'save', 'clean', 'danger', 'threat', 'conservation', 'plastic', 'oil'];
      const foundThemes = environmentalWords.filter(word => fullStory.includes(word));
      
      if (foundThemes.length >= 3) {
        themeScore = 100;
        themeAnalysis.push('âœ… Strong environmental message');
      } else if (foundThemes.length >= 1) {
        themeScore = 60;
        themeAnalysis.push('âš ï¸ Some environmental themes present');
        themeAnalysis.push('ğŸ’¡ Add more conservation themes');
      } else {
        themeScore = 20;
        themeAnalysis.push('âŒ Missing environmental message');
        themeAnalysis.push('ğŸ’¡ Include ocean conservation themes');
      }
      
      // Overall grade calculation
      const overallScore = Math.round((structureScore + characterScore + themeScore) / 3);
      let grade, gradeColor, gradeMessage;
      
      if (overallScore >= 90) {
        grade = 'A+';
        gradeColor = 'text-green-600';
        gradeMessage = 'Outstanding! Your story has excellent structure, character development, and environmental themes.';
      } else if (overallScore >= 80) {
        grade = 'A';
        gradeColor = 'text-green-600';
        gradeMessage = 'Excellent work! Your story is well-developed with strong elements.';
      } else if (overallScore >= 70) {
        grade = 'B+';
        gradeColor = 'text-blue-600';
        gradeMessage = 'Good job! Your story has solid foundations with room for enhancement.';
      } else if (overallScore >= 60) {
        grade = 'B';
        gradeColor = 'text-blue-600';
        gradeMessage = 'Nice work! Continue developing your story elements.';
      } else if (overallScore >= 50) {
        grade = 'C+';
        gradeColor = 'text-yellow-600';
        gradeMessage = 'You\'re on the right track! Focus on the suggestions below.';
      } else {
        grade = 'C';
        gradeColor = 'text-yellow-600';
        gradeMessage = 'Keep writing! Every great story starts with a first draft.';
      }
      
      // Create detailed feedback modal
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = 
        '<div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-96 overflow-y-auto">' +
          '<div class="p-6">' +
            '<div class="flex justify-between items-center mb-6">' +
              '<h3 class="text-2xl font-bold text-sky-700">ğŸ“Š Complete Story Analysis</h3>' +
              '<button id="close-analysis" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>' +
            '</div>' +
            
            '<div class="grid md:grid-cols-2 gap-6 mb-6">' +
              '<div class="bg-gradient-to-r from-blue-50 to-sky-50 p-4 rounded-lg border-2 border-sky-200">' +
                '<h4 class="font-semibold text-sky-700 mb-3">ğŸ“ˆ Overall Grade</h4>' +
                '<div class="text-center">' +
                  '<div class="text-4xl font-bold ' + gradeColor + ' mb-2">' + grade + '</div>' +
                  '<div class="text-lg font-semibold text-gray-700 mb-2">' + overallScore + '/100</div>' +
                  '<p class="text-sm text-gray-600">' + gradeMessage + '</p>' +
                '</div>' +
              '</div>' +
              
              '<div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border-2 border-green-200">' +
                '<h4 class="font-semibold text-green-700 mb-3">ğŸ“Š Story Metrics</h4>' +
                '<div class="space-y-2 text-sm">' +
                  '<div class="flex justify-between"><span>Total Words:</span><strong>' + totalWords + '</strong></div>' +
                  '<div class="flex justify-between"><span>Sections Complete:</span><strong>' + sectionsCompleted + '/5</strong></div>' +
                  '<div class="flex justify-between"><span>Completion:</span><strong>' + completionPercentage + '%</strong></div>' +
                  '<div class="flex justify-between"><span>Environmental Themes:</span><strong>' + foundThemes.length + '</strong></div>' +
                '</div>' +
              '</div>' +
            '</div>' +
            
            '<div class="grid md:grid-cols-3 gap-4 mb-6">' +
              '<div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500">' +
                '<h4 class="font-semibold text-purple-700 mb-3">ğŸ“– Story Structure (' + structureScore + '/100)</h4>' +
                '<ul class="text-sm space-y-1">' +
                  structureAnalysis.map(item => '<li>' + item + '</li>').join('') +
                '</ul>' +
              '</div>' +
              
              '<div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">' +
                '<h4 class="font-semibold text-blue-700 mb-3">ğŸ¦¸â€â™€ï¸ Character Development (' + characterScore + '/100)</h4>' +
                '<ul class="text-sm space-y-1">' +
                  characterAnalysis.map(item => '<li>' + item + '</li>').join('') +
                '</ul>' +
              '</div>' +
              
              '<div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">' +
                '<h4 class="font-semibold text-green-700 mb-3">ğŸŒŠ Environmental Themes (' + themeScore + '/100)</h4>' +
                '<ul class="text-sm space-y-1">' +
                  themeAnalysis.map(item => '<li>' + item + '</li>').join('') +
                '</ul>' +
              '</div>' +
            '</div>' +
            
            '<div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500 mb-6">' +
              '<h4 class="font-semibold text-yellow-700 mb-3">ğŸ¯ Next Steps to Improve</h4>' +
              '<ul class="text-sm space-y-1">' +
                (overallScore < 70 ? '<li>â€¢ Focus on completing all story sections first</li>' : '') +
                (structureScore < 80 ? '<li>â€¢ Develop your plot structure using the Plot Mountain</li>' : '') +
                (characterScore < 80 ? '<li>â€¢ Show more of your guardian\'s personality and powers</li>' : '') +
                (themeScore < 80 ? '<li>â€¢ Include stronger ocean conservation messages</li>' : '') +
                '<li>â€¢ Use the vocabulary bank for more descriptive ocean words</li>' +
                '<li>â€¢ Try the story prompts for inspiration</li>' +
              '</ul>' +
            '</div>' +
            
            '<div class="flex gap-3 justify-end">' +
              '<button id="print-analysis" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">ğŸ–¨ï¸ Print Report</button>' +
              '<button id="continue-writing" class="bg-sky-600 text-white px-4 py-2 rounded hover:bg-sky-700">âœï¸ Continue Writing</button>' +
            '</div>' +
          '</div>' +
        '</div>';
      
      document.body.appendChild(modal);
      
      // Add event listeners
      modal.querySelector('#close-analysis').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      modal.querySelector('#continue-writing').addEventListener('click', () => {
        document.body.removeChild(modal);
        // Switch to story tab
        const storyTabBtn = document.querySelector('.tab-btn[data-tab="story"]');
        if (storyTabBtn) {
          storyTabBtn.click();
        }
      });
      
      modal.querySelector('#print-analysis').addEventListener('click', () => {
        const printContent = 
          'OCEAN GUARDIAN STORY ANALYSIS REPORT\n' +
          '=====================================\n\n' +
          'Student: ' + (document.getElementById('student-name').value || 'Student') + '\n' +
          'Date: ' + new Date().toLocaleDateString() + '\n' +
          'Overall Grade: ' + grade + ' (' + overallScore + '/100)\n\n' +
          'STORY METRICS:\n' +
          '- Total Words: ' + totalWords + '\n' +
          '- Sections Complete: ' + sectionsCompleted + '/5\n' +
          '- Completion: ' + completionPercentage + '%\n\n' +
          'DETAILED ANALYSIS:\n' +
          'Story Structure (' + structureScore + '/100):\n' +
          structureAnalysis.map(item => '  ' + item.replace(/[âœ…âŒâš ï¸]/g, '')).join('\n') + '\n\n' +
          'Character Development (' + characterScore + '/100):\n' +
          characterAnalysis.map(item => '  ' + item.replace(/[âœ…âŒâš ï¸]/g, '')).join('\n') + '\n\n' +
          'Environmental Themes (' + themeScore + '/100):\n' +
          themeAnalysis.map(item => '  ' + item.replace(/[âœ…âŒğŸ’¡âš ï¸]/g, '')).join('\n') + '\n\n' +
          'TEACHER COMMENTS:\n' +
          gradeMessage + '\n\n' +
          '---\n' +
          'Generated by Ocean Guardian Story Builder';
        
        const blob = new Blob([printContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'story-analysis-report.txt';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        alert('ğŸ“Š Analysis report downloaded!\n\nYour detailed story analysis has been saved as a text file.');
      });
      
      // Close modal when clicking outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
    }

    // Plot points functionality
    function initializePlotPoints() {
      console.log('Initializing plot points...');
      
      // Wait for DOM to be ready, then add click handlers
      setTimeout(function() {
        const plotPoints = document.querySelectorAll('.plot-point');
        console.log('Found', plotPoints.length, 'plot points');
        
        plotPoints.forEach(function(point, index) {
          console.log('Adding click handler to plot point', index, 'with stage:', point.getAttribute('data-stage'));
          
          point.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const stage = point.getAttribute('data-stage');
            console.log('Plot point clicked:', stage);
            showPlotFeedback(stage);
          });
          
          // Make it more obvious it's clickable
          point.style.cursor = 'pointer';
          point.style.transition = 'all 0.3s ease';
          
          // Add smooth hover effects
          point.addEventListener('mouseenter', function() {
            point.style.transform = 'scale(1.3)';
            point.style.transformOrigin = 'center center';
            point.style.filter = 'brightness(1.3)';
          });
          
          point.addEventListener('mouseleave', function() {
            point.style.transform = 'scale(1)';
            point.style.transformOrigin = 'center center';
            point.style.filter = 'brightness(1)';
          });
        });
        
        console.log('Plot points initialized with', plotPoints.length, 'interactive points');
      }, 100);
    }

    function showPlotFeedback(stage) {
      const plotFeedback = document.getElementById('plot-feedback');
      
      // Get current story content for analysis
      const currentContent = {
        exposition: document.getElementById('story-beginning').value,
        rising: document.getElementById('story-problem').value,
        climax: document.getElementById('story-action').value,
        falling: document.getElementById('story-falling').value,
        resolution: document.getElementById('story-ending').value
      };
      
      const guardianName = document.getElementById('guardian-name').value;
      const guardianPower = document.getElementById('guardian-power').value;
      
      const stageInfo = {
        exposition: {
          title: 'ğŸŒ… Exposition (Beginning)',
          description: 'This is where you introduce your guardian, establish the setting, and show the normal world before conflict arises.',
          purpose: 'The exposition hooks readers and provides essential background information.',
          literaryElements: [
            'Setting - Where and when does your story take place?',
            'Character Introduction - Who is your guardian?',
            'Mood/Atmosphere - What feeling do you want to create?',
            'Foreshadowing - Hint at the coming conflict'
          ],
          detailedTips: [
            'Use sensory details (sight, sound, touch) to describe the underwater world',
            'Show your guardian\'s personality through actions, not just description',
            'Establish the stakes - what does your guardian care about protecting?',
            'Create a sense of normalcy that will be disrupted by the conflict',
            'Include specific ocean vocabulary to build authenticity'
          ],
          checklistQuestions: [
            'Can readers picture the underwater setting clearly?',
            'Do we understand who your guardian is and what they\'re like?',
            'Is there a sense of what normal life is like in this ocean world?',
            'Have you hinted at what your guardian values most?'
          ],
          commonMistakes: [
            'Starting with too much backstory instead of action',
            'Telling instead of showing character traits',
            'Making the setting too vague or generic',
            'Forgetting to establish what\'s at stake'
          ],
          examples: [
            'Deep in the crystal-clear waters of the Pacific Ocean, Marina the Wave Protector glided gracefully through the coral gardens, her silver scales catching the filtered sunlight as she checked on each reef family...',
            'The morning currents carried Coral through her underwater kingdom, where rainbow fish danced between sea anemones and ancient sea turtles shared stories of the deep...'
          ]
        },
        rising: {
          title: 'âš¡ Rising Action (Problem Develops)',
          description: 'The conflict emerges and tension builds as your guardian discovers the threat to their ocean world.',
          purpose: 'Rising action creates suspense and develops the central conflict that drives your story forward.',
          literaryElements: [
            'Inciting Incident - The moment everything changes',
            'Conflict Development - The problem becomes clear',
            'Character Motivation - Why must your guardian act?',
            'Tension Building - Stakes get higher'
          ],
          detailedTips: [
            'Make the problem feel urgent and threatening',
            'Show how the conflict affects innocent sea creatures',
            'Reveal your guardian\'s emotional response to the crisis',
            'Build tension through pacing - start slow, then accelerate',
            'Connect the problem to real ocean conservation issues'
          ],
          checklistQuestions: [
            'Is the threat to the ocean clearly established?',
            'Do readers understand why your guardian must act?',
            'Can readers feel the urgency of the situation?',
            'Have you shown the impact on other sea creatures?'
          ],
          commonMistakes: [
            'Making the problem too easy to solve',
            'Not showing emotional impact on characters',
            'Rushing through the problem setup',
            'Creating conflicts that don\'t feel meaningful'
          ],
          examples: [
            'Suddenly, Marina noticed the water growing murky. Plastic waste was choking the coral reef, and the fish were swimming in panicked circles, gasping for clean water...',
            'A dark shadow spread across the ocean floor as oil began seeping from a damaged tanker above, threatening everything Coral had sworn to protect...'
          ]
        },
        climax: {
          title: 'ğŸ”ï¸ Climax (Biggest Challenge)',
          description: 'The most intense moment where your guardian faces their greatest challenge and must use everything they\'ve learned.',
          purpose: 'The climax is the turning point where the main conflict reaches its peak intensity.',
          literaryElements: [
            'Highest Tension - The most exciting/dangerous moment',
            'Character Growth - Guardian uses new skills/wisdom',
            'Action Sequence - Dynamic, engaging events',
            'Turning Point - The moment that determines the outcome'
          ],
          detailedTips: [
            'Show your guardian using their unique powers creatively',
            'Include physical action and emotional stakes',
            'Make the outcome uncertain - readers should worry',
            'Demonstrate how your guardian has grown since the beginning',
            'Use short, punchy sentences to create excitement'
          ],
          checklistQuestions: [
            'Is this the most exciting part of your story?',
            'Does your guardian face their biggest fear or challenge?',
            'Are you using your guardian\'s special powers effectively?',
            'Will readers be on the edge of their seats?'
          ],
          commonMistakes: [
            'Making the solution too easy or convenient',
            'Not using the guardian\'s established powers',
            'Resolving conflict without real struggle',
            'Making the climax less exciting than earlier scenes'
          ],
          examples: [
            'Marina summoned all her power, creating massive waves to push the pollution away from the reef while calling every sea creature to help in the greatest rescue the ocean had ever seen...',
            'With the oil spreading fast, Coral dove deeper than ever before, using her healing powers to create a living barrier of strengthened coral that could absorb and neutralize the toxic spill...'
          ]
        },
        falling: {
          title: 'ğŸ“‰ Falling Action (After the Climax)',
          description: 'Events that happen immediately after the climax, showing the consequences of your guardian\'s actions.',
          purpose: 'Falling action bridges the gap between the climax and resolution, showing how tension decreases.',
          literaryElements: [
            'Immediate Consequences - What happens right after the climax?',
            'Character Reactions - How do characters respond to the climax?',
            'Tension Release - How does excitement start to calm down?',
            'Setup for Resolution - What needs to be wrapped up?'
          ],
          detailedTips: [
            'Show the immediate effects of your guardian\'s heroic actions',
            'Describe how other characters react to what just happened',
            'Begin to slow down the pacing after the exciting climax',
            'Address any remaining smaller conflicts or questions',
            'Show your guardian catching their breath or reflecting'
          ],
          checklistQuestions: [
            'Do we see what happens right after the big action?',
            'Are the immediate consequences of the climax clear?',
            'Does the tension start to decrease naturally?',
            'Are you setting up for a satisfying ending?'
          ],
          commonMistakes: [
            'Jumping too quickly from climax to resolution',
            'Not showing the immediate effects of the guardian\'s actions',
            'Maintaining the same high tension as the climax',
            'Forgetting to show character reactions'
          ],
          examples: [
            'As Marina\'s powerful waves pushed the last of the pollution away, the sea creatures slowly emerged from their hiding places, their eyes wide with amazement at what their guardian had accomplished...',
            'The oil spill was contained, but Coral felt exhausted from using so much of her healing power. The other sea creatures gathered around her, offering their support and gratitude...'
          ]
        },
        resolution: {
          title: 'ğŸŒŸ Resolution (Ending)',
          description: 'The conclusion where conflicts are resolved and we see the new normal after your guardian\'s heroic actions.',
          purpose: 'The resolution provides closure and shows the lasting impact of your guardian\'s journey.',
          literaryElements: [
            'Conflict Resolution - How problems are solved',
            'Character Change - How guardian has grown',
            'New Normal - What the world looks like now',
            'Theme/Message - What lesson was learned'
          ],
          detailedTips: [
            'Show the positive outcome of your guardian\'s actions',
            'Reveal what your guardian learned from their adventure',
            'Demonstrate how the ocean world has changed for the better',
            'Include a message about ocean conservation',
            'End with hope and possibility for the future'
          ],
          checklistQuestions: [
            'Are all major conflicts resolved satisfactorily?',
            'Do we see how your guardian has changed/grown?',
            'Is there a clear message about protecting oceans?',
            'Does the ending feel complete and satisfying?'
          ],
          commonMistakes: [
            'Ending too abruptly without showing consequences',
            'Not showing character growth or learning',
            'Forgetting to address all plot threads',
            'Missing the opportunity to include an environmental message'
          ],
          examples: [
            'The ocean was clean once more, and Marina had learned that even the smallest actions can make a big difference. She now taught young sea creatures how to spot and report pollution...',
            'Thanks to Coral\'s bravery, the reef was stronger than ever. The sea creatures celebrated their guardian, and Coral promised to always listen to the ocean\'s needs...'
          ]
        }
      };
      
      const info = stageInfo[stage];
      if (info) {
        // Analyze current content
        const currentText = currentContent[stage] || '';
        const wordCount = currentText.trim().split(/\s+/).filter(word => word.length > 0).length;
        
        let contentAnalysis = '';
        let suggestions = [];
        let strengths = [];
        
        if (currentText.length > 0) {
          // Analyze content quality
          if (wordCount >= 50) strengths.push('Good length - detailed section');
          if (wordCount < 20) suggestions.push('Add more details to reach 20+ words');
          
          // Stage-specific analysis
          if (stage === 'exposition') {
            if (currentText.toLowerCase().includes('ocean') || currentText.toLowerCase().includes('sea')) {
              strengths.push('Great ocean setting established');
            } else {
              suggestions.push('Include more ocean/underwater details');
            }
            if (guardianName && currentText.toLowerCase().includes(guardianName.toLowerCase().split(' ')[0])) {
              strengths.push('Guardian character introduced');
            } else if (guardianName) {
              suggestions.push('Introduce your guardian ' + guardianName + ' by name');
            }
          }
          
          if (stage === 'rising') {
            if (currentText.toLowerCase().includes('pollution') || currentText.toLowerCase().includes('danger') || currentText.toLowerCase().includes('threat')) {
              strengths.push('Clear environmental threat identified');
            } else {
              suggestions.push('Make the ocean threat more specific');
            }
          }
          
          if (stage === 'climax') {
            if (guardianPower && currentText.toLowerCase().includes('power')) {
              strengths.push('Guardian uses their powers');
            } else if (guardianPower) {
              suggestions.push('Show your guardian using their ' + guardianPower + ' power');
            }
          }
          
          if (stage === 'resolution') {
            if (currentText.toLowerCase().includes('learn') || currentText.toLowerCase().includes('safe') || currentText.toLowerCase().includes('protect')) {
              strengths.push('Shows growth and positive outcome');
            } else {
              suggestions.push('Show what your guardian learned');
            }
          }
          
          contentAnalysis = 
            '<div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4">' +
              '<h5 class="font-semibold text-blue-700 mb-2">ğŸ“Š Your Content Analysis</h5>' +
              '<p class="text-sm mb-2"><strong>Word Count:</strong> ' + wordCount + ' words</p>' +
              (strengths.length > 0 ? 
                '<div class="mb-2"><strong class="text-green-600">âœ… Strengths:</strong><ul class="text-sm text-green-700 ml-4">' + 
                strengths.map(s => '<li>â€¢ ' + s + '</li>').join('') + '</ul></div>' : '') +
              (suggestions.length > 0 ? 
                '<div><strong class="text-amber-600">ğŸ’¡ Suggestions:</strong><ul class="text-sm text-amber-700 ml-4">' + 
                suggestions.map(s => '<li>â€¢ ' + s + '</li>').join('') + '</ul></div>' : '') +
            '</div>';
        } else {
          contentAnalysis = 
            '<div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mb-4">' +
              '<h5 class="font-semibold text-yellow-700 mb-2">âœï¸ Ready to Write</h5>' +
              '<p class="text-sm text-yellow-700">This section is empty. Use the guidance below to get started!</p>' +
            '</div>';
        }
        
        plotFeedback.innerHTML = 
          '<div class="bg-white p-6 rounded-lg border-2 border-sky-500 max-h-96 overflow-y-auto">' +
            '<h4 class="font-semibold text-sky-700 mb-3 text-lg">' + info.title + '</h4>' +
            
            contentAnalysis +
            
            '<div class="mb-4">' +
              '<h5 class="font-semibold text-gray-800 mb-2">ğŸ“– What This Section Does:</h5>' +
              '<p class="text-sm text-gray-700 mb-2">' + info.description + '</p>' +
              '<p class="text-xs text-gray-600 italic">' + info.purpose + '</p>' +
            '</div>' +
            
            '<div class="mb-4">' +
              '<h5 class="font-semibold text-gray-800 mb-2">ğŸ­ Literary Elements to Include:</h5>' +
              '<ul class="text-sm text-gray-700 space-y-1">' +
                info.literaryElements.map(element => '<li class="flex items-start"><span class="text-purple-600 mr-2">â–ª</span>' + element + '</li>').join('') +
              '</ul>' +
            '</div>' +
            
            '<div class="mb-4">' +
              '<h5 class="font-semibold text-gray-800 mb-2">ğŸ’¡ Detailed Writing Tips:</h5>' +
              '<ul class="text-sm text-gray-700 space-y-1">' +
                info.detailedTips.map(tip => '<li class="flex items-start"><span class="text-blue-600 mr-2">â€¢</span>' + tip + '</li>').join('') +
              '</ul>' +
            '</div>' +
            
            '<div class="mb-4">' +
              '<h5 class="font-semibold text-gray-800 mb-2">âœ… Quality Checklist:</h5>' +
              '<ul class="text-sm text-gray-700 space-y-1">' +
                info.checklistQuestions.map(question => '<li class="flex items-start"><span class="text-green-600 mr-2">â–¡</span>' + question + '</li>').join('') +
              '</ul>' +
            '</div>' +
            
            '<div class="mb-4">' +
              '<h5 class="font-semibold text-gray-800 mb-2">âš ï¸ Common Mistakes to Avoid:</h5>' +
              '<ul class="text-sm text-red-700 space-y-1">' +
                info.commonMistakes.map(mistake => '<li class="flex items-start"><span class="text-red-600 mr-2">Ã—</span>' + mistake + '</li>').join('') +
              '</ul>' +
            '</div>' +
            
            '<div class="mb-4">' +
              '<h5 class="font-semibold text-gray-800 mb-2">ğŸ“ Example Openings:</h5>' +
              info.examples.map((example, index) => 
                '<div class="bg-gray-50 p-3 rounded mb-2">' +
                  '<p class="text-sm italic text-gray-700 mb-2">' + example + '</p>' +
                  '<button class="use-example-btn bg-sky-600 text-white px-3 py-1 rounded text-xs hover:bg-sky-700" data-example="' + example + '" data-stage="' + stage + '">' +
                    'Use Example ' + (index + 1) +
                  '</button>' +
                '</div>'
              ).join('') +
            '</div>' +
            
            '<div class="flex gap-2 pt-4 border-t">' +
              '<button id="goto-write-btn" class="bg-emerald-600 text-white px-4 py-2 rounded text-sm hover:bg-emerald-700" data-stage="' + stage + '">' +
                'âœï¸ Go Write This Section' +
              '</button>' +
              '<button id="analyze-all-btn" class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700">' +
                'ğŸ“Š Analyze Full Story' +
              '</button>' +
            '</div>' +
          '</div>';
        
        // Add event listeners for new buttons
        const useButtons = plotFeedback.querySelectorAll('.use-example-btn');
        useButtons.forEach(btn => {
          btn.addEventListener('click', function() {
            const example = btn.getAttribute('data-example');
            const stageType = btn.getAttribute('data-stage');
            
            let targetId;
            if (stageType === 'exposition') targetId = 'story-beginning';
            else if (stageType === 'rising') targetId = 'story-problem';
            else if (stageType === 'climax') targetId = 'story-action';
            else if (stageType === 'falling') targetId = 'story-falling';
            else if (stageType === 'resolution') targetId = 'story-ending';
            
            if (targetId) {
              const targetBox = document.getElementById(targetId);
              if (targetBox) {
                if (targetBox.value.trim() === '') {
                  targetBox.value = example;
                } else {
                  targetBox.value += ' ' + example;
                }
                targetBox.focus();
                
                const inputEvent = new Event('input', { bubbles: true });
                targetBox.dispatchEvent(inputEvent);
                
                // Switch to story tab
                const storyTabBtn = document.querySelector('.tab-btn[data-tab="story"]');
                if (storyTabBtn) {
                  storyTabBtn.click();
                }
              }
            }
          });
        });
        
        const gotoWriteBtn = plotFeedback.querySelector('#goto-write-btn');
        if (gotoWriteBtn) {
          gotoWriteBtn.addEventListener('click', function() {
            const stageType = gotoWriteBtn.getAttribute('data-stage');
            
            // Switch to story tab
            const storyTabBtn = document.querySelector('.tab-btn[data-tab="story"]');
            if (storyTabBtn) {
              storyTabBtn.click();
            }
            
            // Focus on the right textarea
            setTimeout(() => {
              let targetId;
              if (stageType === 'exposition') targetId = 'story-beginning';
              else if (stageType === 'rising') targetId = 'story-problem';
              else if (stageType === 'climax') targetId = 'story-action';
              else if (stageType === 'falling') targetId = 'story-falling';
              else if (stageType === 'resolution') targetId = 'story-ending';
              
              if (targetId) {
                const targetBox = document.getElementById(targetId);
                if (targetBox) {
                  targetBox.focus();
                  targetBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
              }
            }, 100);
          });
        }
        
        const analyzeAllBtn = plotFeedback.querySelector('#analyze-all-btn');
        if (analyzeAllBtn) {
          analyzeAllBtn.addEventListener('click', function() {
            showFullStoryAnalysis();
          });
        }
      }
    }

    // Accessibility functionality
    function initializeAccessibility() {
      console.log('Initializing accessibility...');
      
      const accessibilityBtn = document.getElementById('accessibility-btn');
      const accessibilityPanel = document.getElementById('accessibility-panel');
      
      if (accessibilityBtn && accessibilityPanel) {
        accessibilityBtn.addEventListener('click', function() {
          accessibilityPanel.classList.toggle('hidden');
        });
        
        document.addEventListener('click', function(e) {
          if (!accessibilityPanel.contains(e.target) && !accessibilityBtn.contains(e.target)) {
            accessibilityPanel.classList.add('hidden');
          }
        });
      }

      // Accessibility features
      const toggleThemeBtn = document.getElementById('toggle-theme');
      if (toggleThemeBtn) {
        toggleThemeBtn.addEventListener('click', function() {
          document.body.classList.toggle('theme-dark');
        });
      }

      const toggleContrastBtn = document.getElementById('toggle-contrast');
      if (toggleContrastBtn) {
        toggleContrastBtn.addEventListener('click', function() {
          document.body.classList.toggle('theme-high-contrast');
        });
      }

      const fontSizeSelect = document.getElementById('font-size');
      if (fontSizeSelect) {
        fontSizeSelect.addEventListener('change', function(e) {
          document.body.classList.remove('font-large', 'font-xl');
          if (e.target.value === 'large') {
            document.body.classList.add('font-large');
          } else if (e.target.value === 'xl') {
            document.body.classList.add('font-xl');
          }
        });
      }

      const toggleTTSBtn = document.getElementById('toggle-tts');
      if (toggleTTSBtn) {
        toggleTTSBtn.addEventListener('click', function() {
          if ('speechSynthesis' in window) {
            const activeTab = document.querySelector('.tab-content:not(.hidden)');
            const text = activeTab ? activeTab.textContent.substring(0, 200) + '...' : 'Welcome to Ocean Guardian Story Builder';
            const utterance = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(utterance);
          } else {
            alert('Text-to-speech is not supported in your browser.');
          }
        });
      }
      
      console.log('Accessibility initialized');
    }

    // Focus mode functionality
    function initializeFocusMode() {
      console.log('Initializing focus mode...');
      
      let focusActive = false;
      let focusStartTime = null;
      let offTaskCount = 0;
      let totalOffTaskTime = 0;
      let offTaskStartTime = null;
      let wakeLock = null;
      let focusInterval = null;
      
      const focusStartBtn = document.getElementById('focusStartBtn');
      const focusStopBtn = document.getElementById('focusStopBtn');
      const offTaskCountDisplay = document.getElementById('offTaskCount');
      const offTaskTimeDisplay = document.getElementById('offTaskTime');
      const focusAlert = document.getElementById('focus-alert');
      
      if (focusStartBtn) {
        focusStartBtn.addEventListener('click', startFocusMode);
      }
      
      if (focusStopBtn) {
        focusStopBtn.addEventListener('click', stopFocusMode);
      }

      // Track page visibility changes
      document.addEventListener('visibilitychange', function() {
        if (!focusActive) return;
        
        if (document.hidden) {
          // User switched away from tab
          offTaskCount++;
          offTaskStartTime = Date.now();
          offTaskCountDisplay.textContent = offTaskCount;
          
          // Show alert
          focusAlert.style.display = 'block';
          setTimeout(function() {
            focusAlert.style.display = 'none';
          }, 3000);
          
          console.log('Off-task detected, count:', offTaskCount);
        } else {
          // User returned to tab
          if (offTaskStartTime) {
            const offTaskDuration = Date.now() - offTaskStartTime;
            totalOffTaskTime += offTaskDuration;
            offTaskStartTime = null;
            
            const totalOffTaskSeconds = Math.round(totalOffTaskTime / 1000);
            offTaskTimeDisplay.textContent = totalOffTaskSeconds + 's';
            
            console.log('Returned to task, total off-task time:', totalOffTaskSeconds + 's');
          }
        }
      });

      // Track window focus/blur as backup
      window.addEventListener('blur', function() {
        if (!focusActive || document.hidden) return;
        
        offTaskCount++;
        offTaskStartTime = Date.now();
        offTaskCountDisplay.textContent = offTaskCount;
        
        focusAlert.style.display = 'block';
        setTimeout(function() {
          focusAlert.style.display = 'none';
        }, 3000);
        
        console.log('Window blur detected, count:', offTaskCount);
      });

      window.addEventListener('focus', function() {
        if (!focusActive) return;
        
        if (offTaskStartTime) {
          const offTaskDuration = Date.now() - offTaskStartTime;
          totalOffTaskTime += offTaskDuration;
          offTaskStartTime = null;
          
          const totalOffTaskSeconds = Math.round(totalOffTaskTime / 1000);
          offTaskTimeDisplay.textContent = totalOffTaskSeconds + 's';
          
          console.log('Window focus returned, total off-task time:', totalOffTaskSeconds + 's');
        }
      });

      async function startFocusMode() {
        try {
          focusActive = true;
          focusStartTime = Date.now();
          offTaskCount = 0;
          totalOffTaskTime = 0;
          offTaskStartTime = null;
          
          // Reset displays
          offTaskCountDisplay.textContent = '0';
          offTaskTimeDisplay.textContent = '0s';
          
          if (document.documentElement.requestFullscreen) {
            await document.documentElement.requestFullscreen();
          }
          
          if ('wakeLock' in navigator) {
            try {
              wakeLock = await navigator.wakeLock.request('screen');
              document.getElementById('wakeFlag').textContent = 'Active';
            } catch (err) {
              console.log('Wake lock failed:', err);
              document.getElementById('wakeFlag').textContent = 'Failed';
            }
          } else {
            document.getElementById('wakeFlag').textContent = 'Not supported';
          }
          
          // Show wake status
          document.getElementById('wakeStatus').classList.remove('hidden');
          
          focusStartBtn.classList.add('hidden');
          focusStopBtn.classList.remove('hidden');
          document.getElementById('focusStatusDot').classList.remove('bg-red-500');
          document.getElementById('focusStatusDot').classList.add('bg-green-500');
          document.getElementById('focusStatusText').textContent = 'Focus Mode Active';
          
          // Start focus timer display
          focusInterval = setInterval(function() {
            if (focusStartTime) {
              const elapsed = Math.round((Date.now() - focusStartTime) / 1000);
              const minutes = Math.floor(elapsed / 60);
              const seconds = elapsed % 60;
              document.getElementById('focusStatusText').textContent = 'Focus: ' + minutes + 'm ' + seconds + 's';
            }
          }, 1000);
          
          setTimeout(function() {
            alert('ğŸ¯ Focus Mode Activated!\n\nâœ… Tracking enabled:\nâ€¢ Tab switches will be counted\nâ€¢ Off-task time will be measured\nâ€¢ Stay on this page to maintain focus\n\nClick "Stop Focus" when you\'re done writing.');
          }, 1000);
          
        } catch (error) {
          console.log('Focus mode setup failed:', error);
          
          focusActive = true;
          focusStartTime = Date.now();
          offTaskCount = 0;
          totalOffTaskTime = 0;
          
          offTaskCountDisplay.textContent = '0';
          offTaskTimeDisplay.textContent = '0s';
          
          focusStartBtn.classList.add('hidden');
          focusStopBtn.classList.remove('hidden');
          document.getElementById('focusStatusDot').classList.remove('bg-red-500');
          document.getElementById('focusStatusDot').classList.add('bg-green-500');
          document.getElementById('focusStatusText').textContent = 'Focus Mode Active';
          
          // Start focus timer display
          focusInterval = setInterval(function() {
            if (focusStartTime) {
              const elapsed = Math.round((Date.now() - focusStartTime) / 1000);
              const minutes = Math.floor(elapsed / 60);
              const seconds = elapsed % 60;
              document.getElementById('focusStatusText').textContent = 'Focus: ' + minutes + 'm ' + seconds + 's';
            }
          }, 1000);
          
          setTimeout(function() {
            alert('ğŸ¯ Focus Mode Activated!\n\nâœ… Focus tracking is active:\nâ€¢ Tab switches will be counted\nâ€¢ Off-task time will be measured\nâ€¢ Stay on this page and keep writing!\n\nClick "Stop Focus" when done.');
          }, 1000);
        }
      }

      function stopFocusMode() {
        focusActive = false;
        
        if (focusInterval) {
          clearInterval(focusInterval);
          focusInterval = null;
        }
        
        // If currently off-task, add final off-task time
        if (offTaskStartTime) {
          const finalOffTaskDuration = Date.now() - offTaskStartTime;
          totalOffTaskTime += finalOffTaskDuration;
          offTaskStartTime = null;
        }
        
        if (document.exitFullscreen) {
          document.exitFullscreen().catch(function() {});
        }
        
        if (wakeLock) {
          wakeLock.release();
          wakeLock = null;
        }
        
        // Hide wake status
        document.getElementById('wakeStatus').classList.add('hidden');
        
        focusStartBtn.classList.remove('hidden');
        focusStopBtn.classList.add('hidden');
        document.getElementById('focusStatusDot').classList.remove('bg-green-500');
        document.getElementById('focusStatusDot').classList.add('bg-red-500');
        document.getElementById('focusStatusText').textContent = 'Inactive';
        
        const focusTime = focusStartTime ? Math.round((Date.now() - focusStartTime) / 1000) : 0;
        const focusMinutes = Math.floor(focusTime / 60);
        const focusSeconds = focusTime % 60;
        const offTaskMinutes = Math.floor(totalOffTaskTime / 60000);
        const offTaskSeconds = Math.floor((totalOffTaskTime % 60000) / 1000);
        
        const focusPercentage = focusTime > 0 ? Math.round(((focusTime * 1000 - totalOffTaskTime) / (focusTime * 1000)) * 100) : 100;
        
        let message = 'ğŸ“Š Focus Session Complete!\n\n';
        message += 'â±ï¸ Total session time: ' + focusMinutes + 'm ' + focusSeconds + 's\n';
        message += 'ğŸ”„ Tab switches: ' + offTaskCount + '\n';
        message += 'â° Off-task time: ' + offTaskMinutes + 'm ' + offTaskSeconds + 's\n';
        message += 'ğŸ¯ Focus percentage: ' + focusPercentage + '%\n\n';
        
        if (offTaskCount === 0) {
          message += 'ğŸ‰ Perfect focus! You stayed on task the entire time!';
        } else if (offTaskCount <= 2) {
          message += 'ğŸ‘ Good focus! Try to minimize tab switching next time.';
        } else {
          message += 'ğŸ’¡ Consider using website blockers or removing distractions for better focus.';
        }
        
        alert(message);
        
        // Reset counters for next session
        offTaskCount = 0;
        totalOffTaskTime = 0;
        offTaskCountDisplay.textContent = '0';
        offTaskTimeDisplay.textContent = '0s';
      }
      
      console.log('Focus mode initialized with tracking');
    }

    // Copy text functionality
    function initializeCopyText() {
      console.log('Initializing copy text...');
      
      const copyTextBtn = document.getElementById('copy-text-btn');
      if (copyTextBtn) {
        copyTextBtn.addEventListener('click', function() {
          const studentName = document.getElementById('student-name').value || 'Student';
          const guardianData = {
            name: document.getElementById('guardian-name').value,
            power: document.getElementById('guardian-power').value,
            mission: document.getElementById('guardian-mission').value,
            personality: document.getElementById('guardian-personality').value,
            abilities: document.getElementById('guardian-abilities').value,
            weakness: document.getElementById('guardian-weakness').value,
            allies: document.getElementById('guardian-allies').value,
            mentor: document.getElementById('guardian-mentor').value,
            antagonist: document.getElementById('guardian-antagonist').value
          };
          
          const storyData = {
            title: document.getElementById('story-title').value,
            beginning: document.getElementById('story-beginning').value,
            problem: document.getElementById('story-problem').value,
            action: document.getElementById('story-action').value,
            ending: document.getElementById('story-ending').value
          };
          
          const totalWords = [storyData.beginning, storyData.problem, storyData.action, storyData.ending]
            .join(' ').trim().split(/\s+/).filter(function(word) { return word.length > 0; }).length;
          
          // Get power display text
          let powerText = '';
          if (guardianData.power) {
            const powerOption = document.querySelector('option[value="' + guardianData.power + '"]');
            powerText = powerOption ? powerOption.textContent : guardianData.power;
          }
          
          const storyText = 
            'OCEAN GUARDIAN STORY\n' +
            '====================\n\n' +
            'Student: ' + studentName + '\n' +
            'Date: ' + new Date().toLocaleDateString() + '\n' +
            'Word Count: ' + totalWords + ' words\n\n' +
            'GUARDIAN CHARACTER PROFILE\n' +
            '--------------------------\n' +
            'Name: ' + (guardianData.name || 'Not specified') + '\n' +
            'Power: ' + (powerText || 'Not specified') + '\n' +
            'Mission: ' + (guardianData.mission || 'Not specified') + '\n' +
            'Personality: ' + (guardianData.personality || 'Not specified') + '\n' +
            'Abilities: ' + (guardianData.abilities || 'Not specified') + '\n' +
            'Challenge/Weakness: ' + (guardianData.weakness || 'Not specified') + '\n' +
            'Allies: ' + (guardianData.allies || 'Not specified') + '\n' +
            'Mentor: ' + (guardianData.mentor || 'Not specified') + '\n' +
            'Antagonist: ' + (guardianData.antagonist || 'Not specified') + '\n\n' +
            'COMPLETE STORY\n' +
            '--------------\n\n' +
            (storyData.title ? 'Title: ' + storyData.title + '\n\n' : '') +
            'EXPOSITION (Beginning):\n' + (storyData.beginning || 'Not written yet') + '\n\n' +
            'RISING ACTION (Problem):\n' + (storyData.problem || 'Not written yet') + '\n\n' +
            'CLIMAX (Action):\n' + (storyData.action || 'Not written yet') + '\n\n' +
            'RESOLUTION (Ending):\n' + (storyData.ending || 'Not written yet') + '\n\n' +
            '---\n' +
            'Generated by Ocean Guardian Story Builder';
          
          // Copy to clipboard
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(storyText).then(function() {
              // Show success feedback
              const originalText = copyTextBtn.textContent;
              copyTextBtn.textContent = 'âœ… Copied!';
              copyTextBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
              copyTextBtn.classList.add('bg-green-600');
              
              setTimeout(function() {
                copyTextBtn.textContent = originalText;
                copyTextBtn.classList.remove('bg-green-600');
                copyTextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
              }, 2000);
              
              alert('ğŸ“‹ Text Copied Successfully!\n\nYour complete story has been copied to your clipboard!\n\nYou can now:\nâ€¢ Paste it into Google Docs (Ctrl+V or Cmd+V)\nâ€¢ Paste it into Microsoft Word\nâ€¢ Paste it into any document or email\nâ€¢ Share it with your teacher');
            }).catch(function() {
              // Fallback for older browsers
              fallbackCopyText(storyText);
            });
          } else {
            // Fallback for older browsers
            fallbackCopyText(storyText);
          }
          
          function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
              document.execCommand('copy');
              
              // Show success feedback
              const originalText = copyTextBtn.textContent;
              copyTextBtn.textContent = 'âœ… Copied!';
              copyTextBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
              copyTextBtn.classList.add('bg-green-600');
              
              setTimeout(function() {
                copyTextBtn.textContent = originalText;
                copyTextBtn.classList.remove('bg-green-600');
                copyTextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
              }, 2000);
              
              alert('ğŸ“‹ Text Copied Successfully!\n\nYour complete story has been copied!\n\nYou can now paste it into:\nâ€¢ Google Docs\nâ€¢ Microsoft Word\nâ€¢ Any document or email');
            } catch (err) {
              alert('âŒ Copy Failed\n\nSorry, copying is not supported in your browser.\n\nTry using the "ğŸ“„ Export Story" button instead to download a file.');
            }
            
            document.body.removeChild(textArea);
          }
        });
      }
      
      console.log('Copy text initialized');
    }

    // Export functionality
    function initializeExport() {
      console.log('Initializing export...');
      
      const exportBtn = document.getElementById('export-btn');
      if (exportBtn) {
        exportBtn.addEventListener('click', function() {
          const studentName = document.getElementById('student-name').value || 'Student';
          const guardianData = {
            name: document.getElementById('guardian-name').value,
            power: document.getElementById('guardian-power').value,
            mission: document.getElementById('guardian-mission').value,
            personality: document.getElementById('guardian-personality').value,
            abilities: document.getElementById('guardian-abilities').value,
            weakness: document.getElementById('guardian-weakness').value
          };
          
          const storyData = {
            title: document.getElementById('story-title').value,
            beginning: document.getElementById('story-beginning').value,
            problem: document.getElementById('story-problem').value,
            action: document.getElementById('story-action').value,
            ending: document.getElementById('story-ending').value
          };
          
          const totalWords = [storyData.beginning, storyData.problem, storyData.action, storyData.ending]
            .join(' ').trim().split(/\s+/).filter(function(word) { return word.length > 0; }).length;
          
          const storyDocument = 
            'OCEAN GUARDIAN STORY\n' +
            '====================\n\n' +
            'Student: ' + studentName + '\n' +
            'Date: ' + new Date().toLocaleDateString() + '\n' +
            'Word Count: ' + totalWords + ' words\n\n' +
            'GUARDIAN CHARACTER PROFILE\n' +
            '--------------------------\n' +
            'Name: ' + (guardianData.name || 'Not specified') + '\n' +
            'Power: ' + (guardianData.power || 'Not specified') + '\n' +
            'Mission: ' + (guardianData.mission || 'Not specified') + '\n' +
            'Personality: ' + (guardianData.personality || 'Not specified') + '\n' +
            'Abilities: ' + (guardianData.abilities || 'Not specified') + '\n' +
            'Weakness: ' + (guardianData.weakness || 'Not specified') + '\n\n' +
            'COMPLETE STORY\n' +
            '--------------\n\n' +
            (storyData.title ? 'Title: ' + storyData.title + '\n\n' : '') +
            'EXPOSITION (Beginning):\n' + (storyData.beginning || 'Not written yet') + '\n\n' +
            'RISING ACTION (Problem):\n' + (storyData.problem || 'Not written yet') + '\n\n' +
            'CLIMAX (Action):\n' + (storyData.action || 'Not written yet') + '\n\n' +
            'RESOLUTION (Ending):\n' + (storyData.ending || 'Not written yet') + '\n\n' +
            '---\n' +
            'Generated by Ocean Guardian Story Builder';
          
          const blob = new Blob([storyDocument], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = (guardianData.name || studentName) + '-ocean-guardian-story.txt';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          
          alert('ğŸ“„ Story Exported Successfully!\n\nYour complete Ocean Guardian story has been downloaded!\n\nYou can now:\nâ€¢ Email this file to your teacher\nâ€¢ Save it to Google Drive\nâ€¢ Print it for your portfolio');
        });
      }
      
      console.log('Export initialized');
    }

    // Tutorial functionality
    function initializeTutorial() {
      console.log('Initializing tutorial...');
      
      const helpBtn = document.getElementById('help-btn');
      if (helpBtn) {
        helpBtn.addEventListener('click', function() {
          alert('ğŸŒŠ Ocean Guardian Story Builder Help\n\nğŸ“– How to Use:\n1. Create your ocean guardian character\n2. Write your story in four parts\n3. Check the plot structure\n4. Export your finished story\n\nğŸ’¡ Tips:\nâ€¢ Use the vocabulary bank for ocean words\nâ€¢ Try the story prompts for inspiration\nâ€¢ Use Focus Mode to stay concentrated\nâ€¢ Your work auto-saves every 30 seconds');
        });
      }
      
      // Check if tutorial should be shown
      const tutorialCompleted = localStorage.getItem('ocean-guardian-tutorial-completed');
      if (!tutorialCompleted) {
        setTimeout(function() {
          if (confirm('Welcome to Ocean Guardian Story Builder! ğŸŒŠ\n\nWould you like a quick tour to learn how to use this platform?\n\n(You can always click the â“ button later for help)')) {
            alert('ğŸ¯ Quick Tour:\n\n1. ğŸ¦¸â€â™€ï¸ CREATE GUARDIAN - Design your ocean hero\n2. ğŸ“– WRITE STORY - Tell their adventure in 4 parts\n3. ğŸ“ˆ PLOT STRUCTURE - Check your story structure\n4. ğŸ“„ EXPORT - Download your finished story\n\nâœ¨ Features:\nâ€¢ Vocabulary bank with ocean words\nâ€¢ Story prompts for inspiration\nâ€¢ Focus Mode to stay on task\nâ€¢ Auto-save keeps your work safe\n\nHave fun creating your ocean guardian story!');
            localStorage.setItem('ocean-guardian-tutorial-completed', 'true');
          } else {
            localStorage.setItem('ocean-guardian-tutorial-completed', 'true');
          }
        }, 1000);
      }
      
      console.log('Tutorial initialized');
    }

    // Auto-save functionality
    function saveStoryData() {
      const storyData = {
        studentName: document.getElementById('student-name').value,
        guardianName: document.getElementById('guardian-name').value,
        guardianPower: document.getElementById('guardian-power').value,
        guardianMission: document.getElementById('guardian-mission').value,
        guardianPersonality: document.getElementById('guardian-personality').value,
        guardianAbilities: document.getElementById('guardian-abilities').value,
        guardianWeakness: document.getElementById('guardian-weakness').value,
        guardianAllies: document.getElementById('guardian-allies').value,
        guardianMentor: document.getElementById('guardian-mentor').value,
        guardianAntagonist: document.getElementById('guardian-antagonist').value,
        storyTitle: document.getElementById('story-title').value,
        storyBeginning: document.getElementById('story-beginning').value,
        storyProblem: document.getElementById('story-problem').value,
        storyAction: document.getElementById('story-action').value,
        
        storyFalling: document.getElementById('story-falling').value,
        storyEnding: document.getElementById('story-ending').value,
        savedAt: new Date().toLocaleString()
      };
      storyData.schemaVersion = 2;
      localStorage.setItem('ocean-guardian-complete-v2', JSON.stringify(storyData));
      localStorage.setItem('ocean-guardian-complete', JSON.stringify(storyData));
    }

    // Load saved story
    function loadSavedStory() {
      let savedStory = localStorage.getItem('ocean-guardian-complete-v2') || localStorage.getItem('ocean-guardian-complete');
      if (savedStory) {
        try {
          const data = JSON.parse(savedStory);
          
          // Load guardian data
          document.getElementById('student-name').value = data.studentName || '';
          document.getElementById('guardian-name').value = data.guardianName || '';
          document.getElementById('guardian-power').value = data.guardianPower || '';
          document.getElementById('guardian-mission').value = data.guardianMission || '';
          document.getElementById('guardian-personality').value = data.guardianPersonality || '';
          document.getElementById('guardian-abilities').value = data.guardianAbilities || '';
          document.getElementById('guardian-weakness').value = data.guardianWeakness || '';
          document.getElementById('guardian-allies').value = data.guardianAllies || '';
          document.getElementById('guardian-mentor').value = data.guardianMentor || '';
          document.getElementById('guardian-antagonist').value = data.guardianAntagonist || '';
          
          // Load story data
          document.getElementById('story-title').value = data.storyTitle || '';
          document.getElementById('story-beginning').value = data.storyBeginning || '';
          document.getElementById('story-problem').value = data.storyProblem || '';
          document.getElementById('story-action').value = data.storyAction || '';
          
          document.getElementById('story-falling').value = data.storyFalling || '';
          document.getElementById('story-ending').value = data.storyEnding || '';
          
          updateGuardianPreview();
          updateWordCount();
          updateStoryPreview();
        } catch (e) {
          console.log('Could not load saved data');
        }
      }
    }

    // Auto-save every 30 seconds
    
    // Throttled autosave (every 10s only if changed)
    setInterval(function() {
      const now = Date.now();
      if (__dirty && now - __lastSave > 10000) {
        saveStoryData();
        __dirty = false; __lastSave = now;
        const ts = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const ss = document.getElementById('save-status');
        if (ss) ss.textContent = 'Saved â€¢ ' + ts;
      }
    }, 2000);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'975b207f86d5ed72',t:'MTc1NjI5MzA3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
