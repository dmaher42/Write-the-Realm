<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Narrative Quest ‚Äî Mini-Battle & Gear Update</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/styles/main.css">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Lora:wght@400;700&display=swap" rel="stylesheet">
    <style>
        #game,
        #hud,
        #ui {
            position: absolute;
            z-index: 10;
        }
    </style>
</head>
<body>

    <div id="ui-root"></div>

    <div id="kokura-root" style="width:100%;max-width:960px;height:420px;margin:auto;"></div>

    <!-- Start Modal -->
    <div id="start-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="start-heading">
        <div class="modal-content start-modal-content">
            <div class="castle-illustration" aria-hidden="true">
                <svg viewBox="0 0 480 320" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <linearGradient id="castleSky" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#a8d4f3" />
                            <stop offset="100%" stop-color="#e6f1fb" />
                        </linearGradient>
                        <linearGradient id="castleStone" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#f4ede2" />
                            <stop offset="100%" stop-color="#d6c7b0" />
                        </linearGradient>
                        <linearGradient id="castleShadowStone" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0%" stop-color="#d9c9ad" />
                            <stop offset="100%" stop-color="#c4b499" />
                        </linearGradient>
                        <linearGradient id="castleRoof" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#b35c5c" />
                            <stop offset="100%" stop-color="#863b3b" />
                        </linearGradient>
                        <linearGradient id="castleDoor" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#8d5b34" />
                            <stop offset="100%" stop-color="#5c3b1e" />
                        </linearGradient>
                    </defs>
                    <rect width="480" height="220" fill="url(#castleSky)" />
                    <rect y="220" width="480" height="100" fill="#7bbd74" />
                    <circle cx="90" cy="80" r="28" fill="#f6d46a" opacity="0.85" />
                    <path d="M200 220 H280 L300 320 H180 Z" fill="#cba574" opacity="0.85" />
                    <g>
                        <rect x="108" y="126" width="64" height="116" rx="4" fill="url(#castleShadowStone)" />
                        <rect x="308" y="126" width="64" height="116" rx="4" fill="url(#castleStone)" />
                        <rect x="184" y="110" width="112" height="132" rx="4" fill="url(#castleStone)" />
                        <rect x="184" y="100" width="112" height="14" fill="url(#castleShadowStone)" />
                        <rect x="184" y="86" width="20" height="20" fill="url(#castleStone)" />
                        <rect x="216" y="86" width="20" height="20" fill="url(#castleStone)" />
                        <rect x="248" y="86" width="20" height="20" fill="url(#castleStone)" />
                        <rect x="280" y="86" width="16" height="20" fill="url(#castleStone)" />
                        <rect x="300" y="116" width="20" height="20" fill="url(#castleStone)" />
                        <rect x="332" y="116" width="20" height="20" fill="url(#castleStone)" />
                        <rect x="92" y="116" width="20" height="20" fill="url(#castleShadowStone)" />
                        <rect x="124" y="116" width="20" height="20" fill="url(#castleShadowStone)" />
                        <rect x="156" y="116" width="16" height="20" fill="url(#castleShadowStone)" />
                        <rect x="136" y="156" width="20" height="28" rx="5" fill="#5c728c" />
                        <rect x="340" y="156" width="20" height="28" rx="5" fill="#5c728c" />
                        <rect x="232" y="146" width="24" height="32" rx="6" fill="#5c728c" />
                        <rect x="232" y="190" width="24" height="32" rx="6" fill="#5c728c" />
                        <rect x="238" y="204" width="48" height="68" rx="8" fill="url(#castleDoor)" />
                        <circle cx="276" cy="238" r="4" fill="#d7b377" />
                        <path d="M238 220 H286 L298 320 H226 Z" fill="#a97a4a" opacity="0.65" />
                    </g>
                    <g stroke="#704224" stroke-width="4" stroke-linecap="round">
                        <line x1="140" y1="126" x2="140" y2="76" />
                        <line x1="348" y1="126" x2="348" y2="76" />
                    </g>
                    <path d="M140 76 L176 88 L140 98 Z" fill="url(#castleRoof)" />
                    <path d="M348 76 L384 88 L348 96 Z" fill="url(#castleRoof)" />
                    <path d="M184 110 H296 L290 150 H190 Z" fill="rgba(255,255,255,0.1)" />
                    <g fill="#5d8853" opacity="0.9">
                        <circle cx="70" cy="230" r="24" />
                        <circle cx="410" cy="236" r="26" />
                        <circle cx="430" cy="250" r="18" />
                    </g>
                </svg>
            </div>
            <div class="start-modal-copy">
                <h1 id="start-heading" class="text-3xl mb-4">Welcome, Storyteller</h1>
                <p class="mb-6">Your legend awaits. Will you forge a new path or continue an existing journey?</p>
                <div class="flex flex-col sm:flex-row justify-center sm:justify-start gap-4">
                    <button id="new-game-btn">Forge New Legend</button>
                    <button id="continue-game-btn" disabled>Continue Journey</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Creator -->
    <div id="character-creator" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="creator-heading" style="display: none;">
        <div class="modal-content">
            <div class="modal-scroll-content">
                <h1 id="creator-heading" class="text-3xl mb-4">Forge Your Hero</h1>
                <p class="mb-6">Every story needs a beginning. Who is yours?</p>
                <div class="mb-6 text-left">
                    <h2 class="text-xl mb-2">Choose Your Guardian Type</h2>
                    <div id="guardian-type-options" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="creator-option" data-type="Shark Guardian" role="button" tabindex="0"><div class="text-2xl mb-1">ü¶à</div><div class="font-bold">Shark Guardian</div><p class="text-xs">A mighty warrior of the reefs.</p></div>
                        <div class="creator-option" data-type="Jellyfish Guardian" role="button" tabindex="0"><div class="text-2xl mb-1">‚ú®</div><div class="font-bold">Jellyfish Guardian</div><p class="text-xs">A mystical being of light.</p></div>
                        <div class="creator-option" data-type="Manta Ray Guardian" role="button" tabindex="0"><div class="text-2xl mb-1">üåä</div><div class="font-bold">Manta Ray Guardian</div><p class="text-xs">A graceful navigator of the blue.</p></div>
                        <div class="creator-option" data-type="custom" role="button" tabindex="0"><div class="text-2xl mb-1">‚úèÔ∏è</div><div class="font-bold">My Own Guardian</div><p class="text-xs">Describe a hero from imagination.</p></div>
                    </div>
                    <input type="text" id="custom-guardian-input" placeholder="e.g., Sea Turtle, Octopus...">
                </div>
                <div class="mb-6 text-left">
                    <h2 class="text-xl mb-2">Choose Your Realm</h2>
                    <div id="guardian-domain-options" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="creator-option" data-domain="Coral Reef" role="button" tabindex="0"><div class="text-2xl mb-1">üê†</div><p class="text-xs">Coral Reef</p></div>
                        <div class="creator-option" data-domain="Deep Trench" role="button" tabindex="0"><div class="text-2xl mb-1">ü¶ë</div><p class="text-xs">Deep Trench</p></div>
                        <div class="creator-option" data-domain="Kelp Forest" role="button" tabindex="0"><div class="text-2xl mb-1">üåø</div><p class="text-xs">Kelp Forest</p></div>
                    </div>
                </div>
            </div>
            <button id="start-game-btn" class="mt-4">Begin Your Legend</button>
        </div>
    </div>

    <!-- UI Container -->
    <div id="ui-container" style="visibility: hidden;">
        <!-- 3D Realm Viewer -->
        <div id="realm-3d" style="width: 420px; height: 300px; margin: 1rem auto;"></div>
        <!-- Quest Log -->
        <div id="quest-log" class="ui-panel" role="region" aria-labelledby="quest-heading">
            <button id="minimize-quest-log" class="minimize-btn" aria-label="Minimize quest log">-</button>
            <h1 id="quest-heading">Quest Log</h1>
            <div id="quest-log-content">
                <p id="player-level-info" class="font-bold">Level 1 Guardian</p>
                <div class="xp-bar-container"><div id="xp-bar" class="xp-bar"></div></div>
                <p class="mt-2 text-sm">Attack: <span id="player-attack"></span></p>
                <p class="text-sm">Health: <span id="player-health"></span></p>
                <p class="text-sm">Speed: <span id="player-speed"></span></p>
                <ul id="equipment-slots" class="text-sm mt-2">
                    <li>Head: <span id="slot-head">Empty</span></li>
                    <li>Chest: <span id="slot-chest">Empty</span></li>
                    <li>Weapon: <span id="slot-weapon">Empty</span></li>
                </ul>
                <div id="active-quests" class="mt-3 text-sm">
                    <p id="quest-title">No active quest.</p>
                    <p id="quest-objective">The Village Elder seems troubled. Perhaps they have a story to tell.</p>
                </div>
                <div class="flex flex-col gap-2 mt-3">
                    <button id="open-journal-inventory-btn" class="text-sm p-1">Journal & Inventory</button>
                    <button id="save-game-btn" class="text-sm p-1">Save Game</button>
                </div>
            </div>
        </div>

        <!-- Dialogue -->
        <div id="dialogue-box" class="ui-panel" role="dialog" aria-modal="true" aria-labelledby="dialogue-title">
            <h2 id="dialogue-title">Village Elder</h2>
            <p id="dialogue-text">Welcome, hero. A shadow has fallen upon our waters, and we need your strength.</p>
            <div class="flex justify-center"><button id="dialogue-button">Accept Quest</button></div>
        </div>

        <!-- Prewrite Mini-Battle Gate -->
        <div id="prewrite-battle" class="ui-panel" role="dialog" aria-modal="true" aria-labelledby="prewrite-title">
            <h2 id="prewrite-title">Mini-Battle: Plan Your Move</h2>
            <p class="mb-2">Before you write, prepare a quick plan. Win this ‚Äúbattle of ideas‚Äù to unlock the next writing part.</p>
            <div class="hint mb-3"><b>Doing word = action word.</b> Choose one below and use it in a strong sentence.</div>

            <div>
                <h3 class="mb-1">Pick an action word</h3>
                <div id="pre-action-bank" class="chips"></div>
            </div>
            <div class="mt-3">
                <h3 class="mb-1">Choose your focus</h3>
                <div class="card-grid">
                    <div class="pick-card" data-group="who">Hero: <b><span id="focus-who"></span></b></div>
                    <div class="pick-card" data-group="goal">Goal: <b><span id="focus-goal"></span></b></div>
                    <div class="pick-card" data-group="obstacle">Obstacle: <b><span id="focus-obstacle"></span></b></div>
                </div>
            </div>
            <div class="mt-3">
                <label for="prewrite-sentence" class="font-bold">Your battle sentence</label>
                <input id="prewrite-sentence" type="text" placeholder="I ___ through the toxic fog to reach the lighthouse." />
                <div class="text-xs mt-1 text-gray-700">Tip: Use your chosen action word and mention the goal or obstacle.</div>
            </div>
            <div class="flex gap-2 mt-3 justify-center">
                <button id="prewrite-roll-btn" class="text-sm">Shuffle Focus</button>
                <button id="prewrite-submit-btn">Win the Mini-Battle</button>
            </div>
            <div id="prewrite-feedback" class="mt-2"></div>
        </div>

        <!-- Writing Challenge -->
        <div id="writing-challenge" class="ui-panel" role="dialog" aria-modal="true" aria-labelledby="challenge-title">
            <h2 id="narrative-stage"></h2>
            <h3 id="challenge-title">Challenge: Loading...</h3>
            <p id="challenge-prompt">Loading...</p>

            <div id="writing-tips-box" role="region" aria-labelledby="tips-heading">
                <h3 id="tips-heading" class="text-lg font-bold">Writing Tips</h3>
                <p id="current-tips"></p>
                <div class="mt-2 text-sm text-gray-800"><b>Action word = doing word.</b> Try one from the bank below.</div>
            </div>

            <div>
                <div class="font-semibold">Action Word Bank (click to insert)</div>
                <div id="action-word-bank" class="chips"></div>
            </div>

            <textarea id="writing-input" placeholder="My Guardian surges through the waves, gripping the shattered mast as lightning stitches the sky..."></textarea>
            <div id="feedback-area" aria-live="polite"></div>
            <button id="writing-submit">Weave Your Tale</button>
        </div>

        <!-- Dynamic Quest Creator -->
        <div id="dynamic-quest-creator" class="ui-panel" role="dialog" aria-modal="true" aria-labelledby="dynamic-quest-heading">
            <h1 id="dynamic-quest-heading" class="text-2xl">The Storyteller's Choice</h1>
            <p class="my-4">Write a short paragraph describing what happens next. Does a great beast rise? A cursed artifact whisper? Shape the next chapter.</p>
            <textarea id="dynamic-quest-input" placeholder="As the oily slick parts, a colossal shape begins to rise from the depths..."></textarea>
            <button id="dynamic-quest-submit">Shape the Climax</button>
        </div>

        <!-- Monster Created Panel -->
        <div id="monster-created-panel" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="monster-heading" style="display: none;">
            <div class="modal-content text-center">
                <h1 id="monster-heading" class="text-3xl mb-4 text-red-600">From your words, a challenge emerges...</h1>
                <p class="mb-6">Your description has summoned a new foe to the surface!</p>
                <div class="p-6 rounded-lg border-2 border-red-800 bg-red-50 mb-6">
                    <h2 id="monster-name" class="text-2xl font-bold my-2 text-red-800"></h2>
                    <p id="monster-description" class="my-4 text-red-700"></p>
                </div>
                <button id="start-combat-btn" class="bg-red-500 hover:bg-red-700">Continue</button>
            </div>
        </div>

        <!-- Quest Complete -->
        <div id="quest-complete" class="ui-panel text-center" role="dialog" aria-modal="true" aria-labelledby="quest-complete-heading">
            <h1 id="quest-complete-heading" class="text-2xl text-green-600">A Chapter Closes</h1>
            <p id="reward-text" class="my-4 text-lg"></p>
            <div id="improvement-suggestion"></div>
            <div class="flex justify-center gap-4 flex-wrap">
                <button id="try-again-btn">Try Again Myself</button>
                <button id="continue-questing-btn">Continue Questing</button>
            </div>
        </div>

        <!-- Combat Panel -->
        <div id="combat-panel" class="ui-panel" role="dialog" aria-modal="true" aria-labelledby="combat-title">
            <h2 id="combat-title"></h2>
            <p class="mt-4">Your Health:</p>
            <div class="health-bar-container" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" aria-label="Player health">
                <div id="player-health-bar" class="health-bar player"></div>
            </div>
            <p class="mt-2">Enemy Health:</p>
            <div class="health-bar-container" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" aria-label="Enemy health">
                <div id="enemy-health-bar" class="health-bar"></div>
            </div>
            <div id="combat-log" class="mt-4"></div>
            <p id="combat-prompt" class="mt-4 font-bold"></p>
            <div class="flex gap-2 mt-2">
                <input type="text" id="combat-writing-input" class="flex-grow" placeholder="Describe your action...">
                <button id="combat-submit-btn" class="p-2 text-base">Attack!</button>
            </div>
            <button id="special-move-btn" class="mt-2 text-sm p-1 bg-purple-600 hover:bg-purple-800">Use Simile Power (Lvl 2)</button>
        </div>

        <!-- Journal -->
        <div id="journal-panel" class="ui-panel" role="dialog" aria-modal="true" aria-labelledby="journal-heading">
            <h1 id="journal-heading" class="text-2xl">Story Journal</h1>
            <div class="journal-tabs">
                <div id="story-tab" class="journal-tab active">Story</div>
                <div id="achievements-tab" class="journal-tab">Achievements</div>
            </div>
            <div id="journal-entries"></div>
            <div id="achievements-list" style="display: none;"></div>
            <h2 class="text-xl mt-4">Inventory</h2>
            <div id="inventory-list" class="space-y-2"></div>
            <div class="flex justify-center gap-4 mt-4">
                <button id="copy-journal-btn">Copy Story</button>
                <button id="close-journal-btn">Close</button>
            </div>
        </div>

        <!-- Loot Modal -->
        <div id="loot-panel" class="ui-panel text-center" role="dialog" aria-modal="true" aria-labelledby="loot-heading">
            <h2 id="loot-heading" class="text-xl text-green-700 mb-2">You found gear!</h2>
            <div id="loot-card" class="loot-card"></div>
            <div class="flex justify-center gap-2 mt-3">
                <button id="loot-equip-btn">Equip Now</button>
                <button id="loot-close-btn">Keep</button>
            </div>
        </div>

        <div id="interact-prompt" aria-hidden="true">Press [E] to Interact</div>
        <div id="loading-message" role="status" aria-live="polite">The world holds its breath...</div>

        <div id="elder-name" class="npc-name">Village Elder</div>
        <div id="fisherman-name" class="npc-name">Fisherman</div>
        <div id="sage-name" class="npc-name">Sage of the Tides</div>
        <div id="war-torn-elder-name" class="npc-name">War-Torn Elder</div>
        <div id="blacksmith-name" class="npc-name">Blacksmith</div>
        <div id="merchant-name" class="npc-name">Merchant</div>
        <div id="guard-name" class="npc-name">Guard</div>
        <div id="innkeeper-name" class="npc-name">Innkeeper</div>
        <div id="farmer-name" class="npc-name">Farmer</div>

        <div id="controls-info" aria-hidden="true">
            <b>Controls:</b><br><b>W, A, S, D:</b> Move<br><b>E:</b> Interact
        </div>
        <div id="autosave-notification">Auto-saving...</div>
        <div id="achievement-notification">Achievement Unlocked!</div>
    </div>

    <div id="message-box" class="ui-panel" role="alertdialog" aria-modal="true" aria-labelledby="message-text">
        <p id="message-text">Message goes here.</p>
        <button id="message-button">OK</button>
    </div>

    <footer id="credits" style="text-align:center;font-size:0.75rem;margin-top:1rem;">
        Kokura Castle by AVATTA ‚Äî licensed under CC BY 4.0 (via Sketchfab).
        <!-- TODO: add model + license links -->
    </footer>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script type="module" src="./src/main.js"></script>
    <script type="module">
        import { openQuest, grantLoot, setFlag, refreshUI } from './js/realmViewer.js';
        import { mountKokuraVillage } from './js/KokuraVillageScene.js';
        const gameAPI = { openQuest, grantLoot, setFlag, refreshUI, ...(window.gameAPI || {}) };
        const root = document.getElementById('kokura-root');
        if (root) {
            mountKokuraVillage(root, gameAPI);
        }
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
    </script>
</body>
</html>